/*! For license information please see bundle.js.LICENSE.txt */
(()=>{"use strict";function t(e){return t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},t(e)}function e(t,e){for(var r=0;r<e.length;r++){var i=e[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,n(i.key),i)}}function n(e){var n=function(e){if("object"!=t(e)||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,"string");if("object"!=t(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==t(n)?n:n+""}var r=function(){return t=function t(e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.element=e,this.healthBar=e.querySelector("#health-bar .health-value"),this.ammoCounter=e.querySelector("#ammo-counter"),this.weaponInfo=e.querySelector("#weapon-info"),this.statusMessages=e.querySelector("#status-messages"),this.health=100,this.ammo=0,this.weapon="Нет",this.messages=[],this.messageTimer=null,this.initialize()},n=[{key:"initialize",value:function(){this.healthBar&&this.updateHealthBar(),this.ammoCounter&&this.updateAmmoCounter(),this.weaponInfo&&this.updateWeaponInfo()}},{key:"update",value:function(t){void 0!==t.health&&t.health!==this.health&&(this.health=t.health,this.updateHealthBar()),void 0!==t.ammo&&t.ammo!==this.ammo&&(this.ammo=t.ammo,this.updateAmmoCounter()),void 0!==t.weapon&&t.weapon!==this.weapon&&(this.weapon=t.weapon,this.updateWeaponInfo())}},{key:"updateHealthBar",value:function(){this.healthBar&&(this.healthBar.style.width="".concat(this.health,"%"),this.health>70?this.healthBar.style.backgroundColor="#4CAF50":this.health>30?this.healthBar.style.backgroundColor="#FFC107":this.healthBar.style.backgroundColor="#F44336")}},{key:"updateAmmoCounter",value:function(){this.ammoCounter&&(this.ammoCounter.textContent="".concat(this.ammo))}},{key:"updateWeaponInfo",value:function(){this.weaponInfo&&(this.weaponInfo.textContent=this.weapon)}},{key:"addStatusMessage",value:function(t){var e=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:3e3;this.messages.push({text:t,timestamp:Date.now(),duration:n}),this.updateStatusMessages(),null===this.messageTimer&&(this.messageTimer=setInterval((function(){e.checkMessagesTimeout()}),1e3))}},{key:"updateStatusMessages",value:function(){var t=this;this.statusMessages&&(this.statusMessages.innerHTML="",this.messages.forEach((function(e){var n=document.createElement("div");n.className="status-message",n.textContent=e.text,t.statusMessages.appendChild(n)})))}},{key:"checkMessagesTimeout",value:function(){var t=Date.now(),e=!1;this.messages=this.messages.filter((function(n){var r=t-n.timestamp>n.duration;return r&&(e=!0),!r})),e&&this.updateStatusMessages(),0===this.messages.length&&(clearInterval(this.messageTimer),this.messageTimer=null)}},{key:"show",value:function(){this.element.classList.remove("hidden")}},{key:"hide",value:function(){this.element.classList.add("hidden")}}],n&&e(t.prototype,n),Object.defineProperty(t,"prototype",{writable:!1}),t;var t,n}();function i(t){return i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},i(t)}function o(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,a(r.key),r)}}function a(t){var e=function(t){if("object"!=i(t)||!t)return t;var e=t[Symbol.toPrimitive];if(void 0!==e){var n=e.call(t,"string");if("object"!=i(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==i(e)?e:e+""}var s=function(){return t=function t(e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.element=e,this.gridElement=e.querySelector(".inventory-grid"),this.equippedElement=e.querySelector(".equipped-items"),this.inventory={items:[],maxSlots:25},this.equipped={weapon:null,armor:null,helmet:null},this.initialize()},(e=[{key:"initialize",value:function(){this.createInventorySlots(),this.createEquippedSlots(),this.setupDragAndDrop()}},{key:"createInventorySlots",value:function(){if(this.gridElement){this.gridElement.innerHTML="";for(var t=0;t<this.inventory.maxSlots;t++){var e=document.createElement("div");e.className="inventory-slot",e.dataset.slotIndex=t,this.gridElement.appendChild(e)}}}},{key:"createEquippedSlots",value:function(){var t=this;this.equippedElement&&(this.equippedElement.innerHTML="",[{id:"weapon",label:"Оружие"},{id:"armor",label:"Броня"},{id:"helmet",label:"Шлем"}].forEach((function(e){var n=document.createElement("div");n.className="equipped-slot-container";var r=document.createElement("div");r.className="equipped-slot-label",r.textContent=e.label;var i=document.createElement("div");i.className="equipped-slot",i.dataset.slotType=e.id,n.appendChild(r),n.appendChild(i),t.equippedElement.appendChild(n)})))}},{key:"setupDragAndDrop",value:function(){this.element.querySelectorAll(".inventory-slot").forEach((function(t){t.addEventListener("click",(function(){console.log("Клик по слоту инвентаря:",t.dataset.slotIndex)}))})),this.element.querySelectorAll(".equipped-slot").forEach((function(t){t.addEventListener("click",(function(){console.log("Клик по слоту экипировки:",t.dataset.slotType)}))}))}},{key:"update",value:function(t){t&&(this.inventory=t,this.updateInventoryDisplay())}},{key:"updateEquipped",value:function(t){t&&(this.equipped=t,this.updateEquippedDisplay())}},{key:"updateInventoryDisplay",value:function(){var t=this.element.querySelectorAll(".inventory-slot");t.forEach((function(t){t.innerHTML="",t.classList.remove("filled")})),this.inventory.items.forEach((function(e,n){if(!(n>=t.length)){var r=t[n],i=document.createElement("div");switch(i.className="inventory-item",i.dataset.itemId=e.id,e.type){case"weapon":i.classList.add("item-weapon"),i.textContent="W";break;case"medkit":i.classList.add("item-medkit"),i.textContent="M";break;case"ammo":i.classList.add("item-ammo"),i.textContent="A";break;default:i.textContent="?"}r.appendChild(i),r.classList.add("filled")}}))}},{key:"updateEquippedDisplay",value:function(){var t=this.element.querySelector('.equipped-slot[data-slot-type="weapon"]');if(t&&(t.innerHTML="",this.equipped.weapon)){var e=document.createElement("div");e.className="equipped-item item-weapon",e.textContent="W",t.appendChild(e)}var n=this.element.querySelector('.equipped-slot[data-slot-type="armor"]');if(n&&(n.innerHTML="",this.equipped.armor)){var r=document.createElement("div");r.className="equipped-item item-armor",r.textContent="A",n.appendChild(r)}var i=this.element.querySelector('.equipped-slot[data-slot-type="helmet"]');if(i&&(i.innerHTML="",this.equipped.helmet)){var o=document.createElement("div");o.className="equipped-item item-helmet",o.textContent="H",i.appendChild(o)}}},{key:"addInventoryStyles",value:function(){var t=document.createElement("style");t.textContent="\n            .inventory-item {\n                width: 90%;\n                height: 90%;\n                margin: 5%;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                color: white;\n                font-weight: bold;\n                user-select: none;\n                cursor: pointer;\n            }\n            \n            .item-weapon {\n                background-color: #FF5722;\n            }\n            \n            .item-medkit {\n                background-color: #4CAF50;\n            }\n            \n            .item-ammo {\n                background-color: #FFC107;\n            }\n            \n            .item-armor {\n                background-color: #2196F3;\n            }\n            \n            .item-helmet {\n                background-color: #673AB7;\n            }\n            \n            .equipped-slot-container {\n                display: flex;\n                flex-direction: column;\n                align-items: center;\n            }\n            \n            .equipped-slot-label {\n                margin-bottom: 5px;\n                font-size: 14px;\n            }\n            \n            .equipped-item {\n                width: 90%;\n                height: 90%;\n                margin: 5%;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                color: white;\n                font-weight: bold;\n            }\n        ",document.head.appendChild(t)}},{key:"show",value:function(){document.querySelector("style[data-inventory-styles]")||this.addInventoryStyles(),this.element.classList.remove("hidden")}},{key:"hide",value:function(){this.element.classList.add("hidden")}}])&&o(t.prototype,e),Object.defineProperty(t,"prototype",{writable:!1}),t;var t,e}();function c(t){return c="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},c(t)}function u(){u=function(){return e};var t,e={},n=Object.prototype,r=n.hasOwnProperty,i=Object.defineProperty||function(t,e,n){t[e]=n.value},o="function"==typeof Symbol?Symbol:{},a=o.iterator||"@@iterator",s=o.asyncIterator||"@@asyncIterator",l=o.toStringTag||"@@toStringTag";function h(t,e,n){return Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}),t[e]}try{h({},"")}catch(t){h=function(t,e,n){return t[e]=n}}function f(t,e,n,r){var o=e&&e.prototype instanceof w?e:w,a=Object.create(o.prototype),s=new T(r||[]);return i(a,"_invoke",{value:L(t,n,s)}),a}function y(t,e,n){try{return{type:"normal",arg:t.call(e,n)}}catch(t){return{type:"throw",arg:t}}}e.wrap=f;var p="suspendedStart",d="suspendedYield",m="executing",v="completed",g={};function w(){}function b(){}function E(){}var k={};h(k,a,(function(){return this}));var x=Object.getPrototypeOf,S=x&&x(x(I([])));S&&S!==n&&r.call(S,a)&&(k=S);var R=E.prototype=w.prototype=Object.create(k);function P(t){["next","throw","return"].forEach((function(e){h(t,e,(function(t){return this._invoke(e,t)}))}))}function M(t,e){function n(i,o,a,s){var u=y(t[i],t,o);if("throw"!==u.type){var l=u.arg,h=l.value;return h&&"object"==c(h)&&r.call(h,"__await")?e.resolve(h.__await).then((function(t){n("next",t,a,s)}),(function(t){n("throw",t,a,s)})):e.resolve(h).then((function(t){l.value=t,a(l)}),(function(t){return n("throw",t,a,s)}))}s(u.arg)}var o;i(this,"_invoke",{value:function(t,r){function i(){return new e((function(e,i){n(t,r,e,i)}))}return o=o?o.then(i,i):i()}})}function L(e,n,r){var i=p;return function(o,a){if(i===m)throw Error("Generator is already running");if(i===v){if("throw"===o)throw a;return{value:t,done:!0}}for(r.method=o,r.arg=a;;){var s=r.delegate;if(s){var c=j(s,r);if(c){if(c===g)continue;return c}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(i===p)throw i=v,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);i=m;var u=y(e,n,r);if("normal"===u.type){if(i=r.done?v:d,u.arg===g)continue;return{value:u.arg,done:r.done}}"throw"===u.type&&(i=v,r.method="throw",r.arg=u.arg)}}}function j(e,n){var r=n.method,i=e.iterator[r];if(i===t)return n.delegate=null,"throw"===r&&e.iterator.return&&(n.method="return",n.arg=t,j(e,n),"throw"===n.method)||"return"!==r&&(n.method="throw",n.arg=new TypeError("The iterator does not provide a '"+r+"' method")),g;var o=y(i,e.iterator,n.arg);if("throw"===o.type)return n.method="throw",n.arg=o.arg,n.delegate=null,g;var a=o.arg;return a?a.done?(n[e.resultName]=a.value,n.next=e.nextLoc,"return"!==n.method&&(n.method="next",n.arg=t),n.delegate=null,g):a:(n.method="throw",n.arg=new TypeError("iterator result is not an object"),n.delegate=null,g)}function O(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function C(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function T(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(O,this),this.reset(!0)}function I(e){if(e||""===e){var n=e[a];if(n)return n.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var i=-1,o=function n(){for(;++i<e.length;)if(r.call(e,i))return n.value=e[i],n.done=!1,n;return n.value=t,n.done=!0,n};return o.next=o}}throw new TypeError(c(e)+" is not iterable")}return b.prototype=E,i(R,"constructor",{value:E,configurable:!0}),i(E,"constructor",{value:b,configurable:!0}),b.displayName=h(E,l,"GeneratorFunction"),e.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===b||"GeneratorFunction"===(e.displayName||e.name))},e.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,E):(t.__proto__=E,h(t,l,"GeneratorFunction")),t.prototype=Object.create(R),t},e.awrap=function(t){return{__await:t}},P(M.prototype),h(M.prototype,s,(function(){return this})),e.AsyncIterator=M,e.async=function(t,n,r,i,o){void 0===o&&(o=Promise);var a=new M(f(t,n,r,i),o);return e.isGeneratorFunction(n)?a:a.next().then((function(t){return t.done?t.value:a.next()}))},P(R),h(R,l,"Generator"),h(R,a,(function(){return this})),h(R,"toString",(function(){return"[object Generator]"})),e.keys=function(t){var e=Object(t),n=[];for(var r in e)n.push(r);return n.reverse(),function t(){for(;n.length;){var r=n.pop();if(r in e)return t.value=r,t.done=!1,t}return t.done=!0,t}},e.values=I,T.prototype={constructor:T,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=t,this.done=!1,this.delegate=null,this.method="next",this.arg=t,this.tryEntries.forEach(C),!e)for(var n in this)"t"===n.charAt(0)&&r.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=t)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var n=this;function i(r,i){return s.type="throw",s.arg=e,n.next=r,i&&(n.method="next",n.arg=t),!!i}for(var o=this.tryEntries.length-1;o>=0;--o){var a=this.tryEntries[o],s=a.completion;if("root"===a.tryLoc)return i("end");if(a.tryLoc<=this.prev){var c=r.call(a,"catchLoc"),u=r.call(a,"finallyLoc");if(c&&u){if(this.prev<a.catchLoc)return i(a.catchLoc,!0);if(this.prev<a.finallyLoc)return i(a.finallyLoc)}else if(c){if(this.prev<a.catchLoc)return i(a.catchLoc,!0)}else{if(!u)throw Error("try statement without catch or finally");if(this.prev<a.finallyLoc)return i(a.finallyLoc)}}}},abrupt:function(t,e){for(var n=this.tryEntries.length-1;n>=0;--n){var i=this.tryEntries[n];if(i.tryLoc<=this.prev&&r.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var o=i;break}}o&&("break"===t||"continue"===t)&&o.tryLoc<=e&&e<=o.finallyLoc&&(o=null);var a=o?o.completion:{};return a.type=t,a.arg=e,o?(this.method="next",this.next=o.finallyLoc,g):this.complete(a)},complete:function(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),g},finish:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var n=this.tryEntries[e];if(n.finallyLoc===t)return this.complete(n.completion,n.afterLoc),C(n),g}},catch:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var n=this.tryEntries[e];if(n.tryLoc===t){var r=n.completion;if("throw"===r.type){var i=r.arg;C(n)}return i}}throw Error("illegal catch attempt")},delegateYield:function(e,n,r){return this.delegate={iterator:I(e),resultName:n,nextLoc:r},"next"===this.method&&(this.arg=t),g}},e}function l(t,e,n,r,i,o,a){try{var s=t[o](a),c=s.value}catch(t){return void n(t)}s.done?e(c):Promise.resolve(c).then(r,i)}function h(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,f(r.key),r)}}function f(t){var e=function(t){if("object"!=c(t)||!t)return t;var e=t[Symbol.toPrimitive];if(void 0!==e){var n=e.call(t,"string");if("object"!=c(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==c(e)?e:e+""}var y=function(){return t=function t(e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.game=e,this.loadingScreen=document.getElementById("loading-screen"),this.mainMenu=document.getElementById("main-menu"),this.gameCanvas=document.getElementById("game-canvas"),this.hudElement=document.getElementById("hud"),this.inventoryScreen=document.getElementById("inventory-screen"),this.loadingStatus=document.getElementById("loading-status"),this.components={hud:null,inventory:null}},e=[{key:"initComponents",value:(n=u().mark((function t(){return u().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return this.components={hud:this.hudElement?new r(this.hudElement):null,inventory:this.inventoryScreen?new s(this.inventoryScreen):null},t.abrupt("return",!0);case 2:case"end":return t.stop()}}),t,this)})),i=function(){var t=this,e=arguments;return new Promise((function(r,i){var o=n.apply(t,e);function a(t){l(o,r,i,a,s,"next",t)}function s(t){l(o,r,i,a,s,"throw",t)}a(void 0)}))},function(){return i.apply(this,arguments)})},{key:"updateLoadingStatus",value:function(t){this.loadingStatus&&(this.loadingStatus.textContent=t),Ct(t)}},{key:"showErrorScreen",value:function(t){var e=document.getElementById("error-screen");if(e){var n=document.getElementById("error-message");n&&(n.textContent=t)}else{(e=document.createElement("div")).id="error-screen",e.className="error-overlay",e.innerHTML='\n                <div class="error-container">\n                    <h2>Произошла ошибка</h2>\n                    <p id="error-message">'.concat(t,'</p>\n                    <button id="reload-button">Перезагрузить</button>\n                </div>\n            '),document.body.appendChild(e);var r=document.getElementById("reload-button");r&&r.addEventListener("click",(function(){window.location.reload()}));var i=document.createElement("style");i.textContent="\n                .error-overlay {\n                    position: fixed;\n                    top: 0;\n                    left: 0;\n                    width: 100%;\n                    height: 100%;\n                    background-color: rgba(0, 0, 0, 0.85);\n                    z-index: 9999;\n                    display: flex;\n                    justify-content: center;\n                    align-items: center;\n                }\n                .error-container {\n                    background-color: #333;\n                    padding: 20px;\n                    border: 2px solid #f44336;\n                    max-width: 80%;\n                    text-align: center;\n                }\n                .error-container h2 {\n                    color: #f44336;\n                    margin-bottom: 15px;\n                }\n                .error-container p {\n                    color: #fff;\n                    margin-bottom: 20px;\n                    font-family: monospace;\n                    white-space: pre-wrap;\n                    text-align: left;\n                }\n                #reload-button {\n                    background-color: #4CAF50;\n                    color: white;\n                    border: none;\n                    padding: 10px 20px;\n                    cursor: pointer;\n                    font-size: 16px;\n                }\n                #reload-button:hover {\n                    background-color: #45a049;\n                }\n            ",document.head.appendChild(i)}this.loadingScreen&&this.loadingScreen.classList.add("hidden")}},{key:"showMainMenu",value:function(){this.loadingScreen&&this.loadingScreen.classList.add("hidden"),this.mainMenu&&this.mainMenu.classList.remove("hidden"),this.game.state.currentScene="menu",Ct("Главное меню отображено")}},{key:"hideMainMenu",value:function(){this.mainMenu&&this.mainMenu.classList.add("hidden")}},{key:"showGameScreen",value:function(){this.gameCanvas&&this.gameCanvas.classList.remove("hidden"),this.hudElement&&this.hudElement.classList.remove("hidden")}},{key:"update",value:function(){this.game.world.player&&this.components.hud&&this.components.hud.update({health:this.game.world.player.health,ammo:this.game.world.player.ammo,weapon:this.game.world.player.weapon})}},{key:"toggleInventory",value:function(){this.inventoryScreen.classList.contains("hidden")?this.showInventory():this.hideInventory()}},{key:"showInventory",value:function(){this.inventoryScreen.classList.remove("hidden"),this.components.inventory&&this.components.inventory.show(),this.game.input&&this.game.input.disableGameControls()}},{key:"hideInventory",value:function(){this.inventoryScreen.classList.add("hidden"),this.components.inventory&&this.components.inventory.hide(),this.game.input&&this.game.input.enableGameControls()}}],e&&h(t.prototype,e),Object.defineProperty(t,"prototype",{writable:!1}),t;var t,e,n,i}();function p(t){return p="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},p(t)}function d(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,r)}return n}function m(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?d(Object(n),!0).forEach((function(e){v(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):d(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}function v(t,e,n){return(e=w(e))in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function g(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,w(r.key),r)}}function w(t){var e=function(t){if("object"!=p(t)||!t)return t;var e=t[Symbol.toPrimitive];if(void 0!==e){var n=e.call(t,"string");if("object"!=p(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==p(e)?e:e+""}var b=function(){return t=function t(e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.id=e.id||"local_player",this.isLocalPlayer=void 0===e.isLocalPlayer||e.isLocalPlayer,this.position=e.position||{x:0,y:0,z:0},this.rotation=e.rotation||{x:0,y:0,z:0},this.direction={x:0,z:-1},this.health=e.health||100,this.maxHealth=e.maxHealth||100,this.speed=e.speed||5,this.weapon=e.weapon||"pistol",this.ammo=e.ammo||30,this.weaponType="single",this.fireRate=500,this.recoil={x:.05,y:.05},this.inventory=e.inventory||{items:[],maxSlots:25},this.isMoving=!1,this.isRunning=!1,this.isAiming=!1,this.isShooting=!1,this.canShoot=!0,this.lastShootTime=0,this.currentState="idle",this.viewAngle=90,this.normalViewAngle=90,this.aimingViewAngle=45,this.runningViewAngle=70,this.viewDistance=50,this.normalSpeed=5,this.runningSpeed=7.5,this.aimingSpeed=1.5,this.acceleration=10,this.velocity={x:0,z:0},this.renderer=e.renderer,this.input=e.input,this.game=e.game,this.mesh=null,this.isLocalPlayer&&this.setupControls(),this.createModel()},(e=[{key:"createModel",value:function(){this.renderer&&(this.mesh=this.renderer.addPlayer({position:this.position,rotation:this.rotation,isLocalPlayer:this.isLocalPlayer}))}},{key:"setupControls",value:function(){var t=this;this.input&&(this.input.setMouseDownCallback((function(e,n){0===e&&t.startAiming()})),this.input.setMouseUpCallback((function(e){0===e&&t.stopAiming()})),this.input.setRightClickCallback((function(){t.tryShoot()})),this.input.setMouseMoveCallback((function(e,n){t.handleMouseMove(e)})))}},{key:"startAiming",value:function(){this.isAiming=!0,this.speed=this.aimingSpeed,this.viewAngle=this.aimingViewAngle,console.log("Начало прицеливания")}},{key:"stopAiming",value:function(){this.isAiming=!1,this.speed=this.normalSpeed,this.viewAngle=this.normalViewAngle,console.log("Конец прицеливания")}},{key:"tryShoot",value:function(){var t=this;if(this.isAiming&&this.canShoot&&!(this.ammo<=0)){var e=Date.now();e-this.lastShootTime<this.fireRate||(this.lastShootTime=e,this.ammo--,this.isShooting=!0,setTimeout((function(){t.isShooting=!1}),100),this.applyRecoil(),this.createShot(),"single"===this.weaponType&&(this.canShoot=!1,setTimeout((function(){t.canShoot=!0}),this.fireRate)),this.game&&this.game.network&&this.game.network.sendPlayerShoot(this.position,this.direction,this.weapon))}}},{key:"applyRecoil",value:function(){var t=(Math.random()-.5)*this.recoil.x*2,e=-Math.abs(Math.random()*this.recoil.y),n=this.input.getMousePosition(),r={x:n.x+100*t,y:n.y+100*e};this.handleMouseMove(r)}},{key:"handleMouseMove",value:function(t){var e=this.renderer.canvas.getBoundingClientRect(),n=e.left+e.width/2,r=e.top+e.height/2,i={x:t.x-n,y:t.y-r},o=Math.sqrt(i.x*i.x+i.y*i.y);o>0&&(i.x/=o,i.y/=o);var a=Math.atan2(i.x,-i.y);this.rotation.y=a,this.direction={x:Math.sin(a),z:-Math.cos(a)}}},{key:"update",value:function(t){t&&(this.isLocalPlayer&&(this.handleMovement(t),this.renderer&&this.renderer.updateCamera(this.position),this.handleRunning(),this.updateAnimationState()),this.updateModel())}},{key:"handleRunning",value:function(){if(this.input){var t=this.isRunning;this.input.isKeyPressed("ShiftLeft")&&!this.isAiming?this.isRunning||(this.isRunning=!0,this.speed=this.runningSpeed,this.viewAngle=this.runningViewAngle):this.isRunning&&(this.isRunning=!1,this.speed=this.isAiming?this.aimingSpeed:this.normalSpeed,this.viewAngle=this.isAiming?this.aimingViewAngle:this.normalViewAngle),t!==this.isRunning&&console.log(this.isRunning?"Начало бега":"Конец бега")}}},{key:"updateAnimationState",value:function(){var t="idle";this.isMoving&&(t=this.isRunning?"run":"walk"),this.isAiming&&(t="aim"),this.isShooting&&(t="shoot"),this.currentState!==t&&(this.currentState=t,console.log("Состояние анимации: ".concat(this.currentState)))}},{key:"handleMovement",value:function(t){if(this.input){var e=this.input.getMovementDirection();if(0===e.x&&0===e.z)this.velocity.x*=.9,this.velocity.z*=.9,Math.abs(this.velocity.x)<.01&&Math.abs(this.velocity.z)<.01&&(this.velocity.x=0,this.velocity.z=0,this.isMoving=!1);else{this.isMoving=!0;var n=Math.sqrt(e.x*e.x+e.z*e.z),r={x:e.x/n,z:e.z/n},i={x:r.x*this.speed,z:r.z*this.speed};this.velocity.x+=(i.x-this.velocity.x)*this.acceleration*t,this.velocity.z+=(i.z-this.velocity.z)*this.acceleration*t}var o=this.position.x+this.velocity.x*t,a=this.position.z+this.velocity.z*t,s=this.checkCollision({x:o,y:this.position.y,z:this.position.z}),c=this.checkCollision({x:this.position.x,y:this.position.y,z:a});s?this.position.x=o:this.velocity.x=0,c?this.position.z=a:this.velocity.z=0,this.game&&this.game.network&&this.game.network.sendPlayerMove(this.position,this.rotation)}}},{key:"checkCollision",value:function(t){return!(Math.abs(t.x)>500||Math.abs(t.z)>500)}},{key:"createShot",value:function(){if(this.renderer&&this.renderer.scene){var t=m({},this.position);t.y+=1;var e={x:t.x+100*this.direction.x,y:t.y,z:t.z+100*this.direction.z};this.renderer.createTemporaryBeam(t,e,16711680,100),console.log("Выстрел!",this.direction)}}},{key:"updateModel",value:function(){this.mesh&&this.renderer&&this.renderer.updateObjectTransform(this.mesh,this.position,this.rotation)}},{key:"getViewAngle",value:function(){return this.viewAngle}},{key:"getViewDistance",value:function(){return this.viewDistance}},{key:"getViewDirection",value:function(){return m({},this.direction)}}])&&g(t.prototype,e),Object.defineProperty(t,"prototype",{writable:!1}),t;var t,e}();function E(t){return E="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},E(t)}function k(){k=function(){return e};var t,e={},n=Object.prototype,r=n.hasOwnProperty,i=Object.defineProperty||function(t,e,n){t[e]=n.value},o="function"==typeof Symbol?Symbol:{},a=o.iterator||"@@iterator",s=o.asyncIterator||"@@asyncIterator",c=o.toStringTag||"@@toStringTag";function u(t,e,n){return Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}),t[e]}try{u({},"")}catch(t){u=function(t,e,n){return t[e]=n}}function l(t,e,n,r){var o=e&&e.prototype instanceof v?e:v,a=Object.create(o.prototype),s=new T(r||[]);return i(a,"_invoke",{value:L(t,n,s)}),a}function h(t,e,n){try{return{type:"normal",arg:t.call(e,n)}}catch(t){return{type:"throw",arg:t}}}e.wrap=l;var f="suspendedStart",y="suspendedYield",p="executing",d="completed",m={};function v(){}function g(){}function w(){}var b={};u(b,a,(function(){return this}));var x=Object.getPrototypeOf,S=x&&x(x(I([])));S&&S!==n&&r.call(S,a)&&(b=S);var R=w.prototype=v.prototype=Object.create(b);function P(t){["next","throw","return"].forEach((function(e){u(t,e,(function(t){return this._invoke(e,t)}))}))}function M(t,e){function n(i,o,a,s){var c=h(t[i],t,o);if("throw"!==c.type){var u=c.arg,l=u.value;return l&&"object"==E(l)&&r.call(l,"__await")?e.resolve(l.__await).then((function(t){n("next",t,a,s)}),(function(t){n("throw",t,a,s)})):e.resolve(l).then((function(t){u.value=t,a(u)}),(function(t){return n("throw",t,a,s)}))}s(c.arg)}var o;i(this,"_invoke",{value:function(t,r){function i(){return new e((function(e,i){n(t,r,e,i)}))}return o=o?o.then(i,i):i()}})}function L(e,n,r){var i=f;return function(o,a){if(i===p)throw Error("Generator is already running");if(i===d){if("throw"===o)throw a;return{value:t,done:!0}}for(r.method=o,r.arg=a;;){var s=r.delegate;if(s){var c=j(s,r);if(c){if(c===m)continue;return c}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(i===f)throw i=d,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);i=p;var u=h(e,n,r);if("normal"===u.type){if(i=r.done?d:y,u.arg===m)continue;return{value:u.arg,done:r.done}}"throw"===u.type&&(i=d,r.method="throw",r.arg=u.arg)}}}function j(e,n){var r=n.method,i=e.iterator[r];if(i===t)return n.delegate=null,"throw"===r&&e.iterator.return&&(n.method="return",n.arg=t,j(e,n),"throw"===n.method)||"return"!==r&&(n.method="throw",n.arg=new TypeError("The iterator does not provide a '"+r+"' method")),m;var o=h(i,e.iterator,n.arg);if("throw"===o.type)return n.method="throw",n.arg=o.arg,n.delegate=null,m;var a=o.arg;return a?a.done?(n[e.resultName]=a.value,n.next=e.nextLoc,"return"!==n.method&&(n.method="next",n.arg=t),n.delegate=null,m):a:(n.method="throw",n.arg=new TypeError("iterator result is not an object"),n.delegate=null,m)}function O(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function C(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function T(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(O,this),this.reset(!0)}function I(e){if(e||""===e){var n=e[a];if(n)return n.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var i=-1,o=function n(){for(;++i<e.length;)if(r.call(e,i))return n.value=e[i],n.done=!1,n;return n.value=t,n.done=!0,n};return o.next=o}}throw new TypeError(E(e)+" is not iterable")}return g.prototype=w,i(R,"constructor",{value:w,configurable:!0}),i(w,"constructor",{value:g,configurable:!0}),g.displayName=u(w,c,"GeneratorFunction"),e.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===g||"GeneratorFunction"===(e.displayName||e.name))},e.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,w):(t.__proto__=w,u(t,c,"GeneratorFunction")),t.prototype=Object.create(R),t},e.awrap=function(t){return{__await:t}},P(M.prototype),u(M.prototype,s,(function(){return this})),e.AsyncIterator=M,e.async=function(t,n,r,i,o){void 0===o&&(o=Promise);var a=new M(l(t,n,r,i),o);return e.isGeneratorFunction(n)?a:a.next().then((function(t){return t.done?t.value:a.next()}))},P(R),u(R,c,"Generator"),u(R,a,(function(){return this})),u(R,"toString",(function(){return"[object Generator]"})),e.keys=function(t){var e=Object(t),n=[];for(var r in e)n.push(r);return n.reverse(),function t(){for(;n.length;){var r=n.pop();if(r in e)return t.value=r,t.done=!1,t}return t.done=!0,t}},e.values=I,T.prototype={constructor:T,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=t,this.done=!1,this.delegate=null,this.method="next",this.arg=t,this.tryEntries.forEach(C),!e)for(var n in this)"t"===n.charAt(0)&&r.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=t)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var n=this;function i(r,i){return s.type="throw",s.arg=e,n.next=r,i&&(n.method="next",n.arg=t),!!i}for(var o=this.tryEntries.length-1;o>=0;--o){var a=this.tryEntries[o],s=a.completion;if("root"===a.tryLoc)return i("end");if(a.tryLoc<=this.prev){var c=r.call(a,"catchLoc"),u=r.call(a,"finallyLoc");if(c&&u){if(this.prev<a.catchLoc)return i(a.catchLoc,!0);if(this.prev<a.finallyLoc)return i(a.finallyLoc)}else if(c){if(this.prev<a.catchLoc)return i(a.catchLoc,!0)}else{if(!u)throw Error("try statement without catch or finally");if(this.prev<a.finallyLoc)return i(a.finallyLoc)}}}},abrupt:function(t,e){for(var n=this.tryEntries.length-1;n>=0;--n){var i=this.tryEntries[n];if(i.tryLoc<=this.prev&&r.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var o=i;break}}o&&("break"===t||"continue"===t)&&o.tryLoc<=e&&e<=o.finallyLoc&&(o=null);var a=o?o.completion:{};return a.type=t,a.arg=e,o?(this.method="next",this.next=o.finallyLoc,m):this.complete(a)},complete:function(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),m},finish:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var n=this.tryEntries[e];if(n.finallyLoc===t)return this.complete(n.completion,n.afterLoc),C(n),m}},catch:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var n=this.tryEntries[e];if(n.tryLoc===t){var r=n.completion;if("throw"===r.type){var i=r.arg;C(n)}return i}}throw Error("illegal catch attempt")},delegateYield:function(e,n,r){return this.delegate={iterator:I(e),resultName:n,nextLoc:r},"next"===this.method&&(this.arg=t),m}},e}function x(t,e,n,r,i,o,a){try{var s=t[o](a),c=s.value}catch(t){return void n(t)}s.done?e(c):Promise.resolve(c).then(r,i)}function S(t){return function(){var e=this,n=arguments;return new Promise((function(r,i){var o=t.apply(e,n);function a(t){x(o,r,i,a,s,"next",t)}function s(t){x(o,r,i,a,s,"throw",t)}a(void 0)}))}}function R(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,P(r.key),r)}}function P(t){var e=function(t){if("object"!=E(t)||!t)return t;var e=t[Symbol.toPrimitive];if(void 0!==e){var n=e.call(t,"string");if("object"!=E(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==E(e)?e:e+""}var M=function(){return t=function t(e){if(function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),e.scene&&e.player){this.scene=e.scene,this.world=e.world,this.player=e.player,this.fov=void 0!==e.fov?e.fov:90,this.rayCount=e.rayCount||60,this.maxDistance=e.maxDistance||50,this.memoryEnabled=void 0===e.memoryEnabled||e.memoryEnabled,this.blurEdges=void 0===e.blurEdges||e.blurEdges,this.normalFov=90,this.aimingFov=45,this.runningFov=70,this.visibilityMask=null,this.memoryMask=null,this.visibilityShape=null,this.currentVisionMesh=null,this.cellSize=e.cellSize||5,this.gridSize=1e3,this.gridResolution=Math.ceil(this.gridSize/this.cellSize),this.memoryGrid=new Array(this.gridResolution),this.isInitialized=!1,this.isRapierReady=!1,this.isRapierChecked=!1,this.initializationPromise=null,this.lastErrorTime=0,this.updateInterval=e.updateInterval||0,this.lastUpdateTime=0,this.errorCooldown=5e3;for(var n=0;n<this.gridResolution;n++)this.memoryGrid[n]=new Array(this.gridResolution).fill(0);this.visibilityGroup=new THREE.Group,this.scene.add(this.visibilityGroup),this.init()}else console.error("VisionSystem: не указаны обязательные параметры (scene, player)")},e=[{key:"init",value:(r=S(k().mark((function t(){var e=this;return k().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!this.initializationPromise){t.next=2;break}return t.abrupt("return",this.initializationPromise);case 2:return this.initializationPromise=new Promise(function(){var t=S(k().mark((function t(n){return k().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,console.log("VisionSystem: начало инициализации..."),e.initVisibilityLayers(),t.next=5,e.checkRapierAvailability();case 5:e.isInitialized=!0,console.log("VisionSystem: успешно инициализирована"),n(!0),t.next=14;break;case 10:t.prev=10,t.t0=t.catch(0),console.error("VisionSystem: ошибка при инициализации:",t.t0),n(!1);case 14:case"end":return t.stop()}}),t,null,[[0,10]])})));return function(e){return t.apply(this,arguments)}}()),t.abrupt("return",this.initializationPromise);case 4:case"end":return t.stop()}}),t,this)}))),function(){return r.apply(this,arguments)})},{key:"checkRapierAvailability",value:(n=S(k().mark((function t(){var e=this;return k().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!this.isRapierChecked){t.next=2;break}return t.abrupt("return",this.isRapierReady);case 2:return t.abrupt("return",new Promise((function(t){var n=function(){return e.getRapierInstance()?(console.log("VisionSystem: RAPIER доступен"),e.isRapierReady=!0,e.isRapierChecked=!0,void t(!0)):!e.world||"function"!=typeof e.world.castRay&&"function"!=typeof e.world.castRayAndGetNormal?void setTimeout(n,100):(console.log("VisionSystem: мир физики доступен и поддерживает рейкасты"),e.isRapierReady=!0,e.isRapierChecked=!0,void t(!0))};n()})));case 3:case"end":return t.stop()}}),t,this)}))),function(){return n.apply(this,arguments)})},{key:"getRapierInstance",value:function(){return"undefined"!=typeof RAPIER?RAPIER:"undefined"!=typeof window&&window.RAPIER?window.RAPIER:null}},{key:"initVisibilityLayers",value:function(){this.createFogOfWarLayer(),this.createMemoryLayer(),this.createVisionConeLayer()}},{key:"createFogOfWarLayer",value:function(){var t=new THREE.PlaneGeometry(1.5*this.gridSize,1.5*this.gridSize),e=new THREE.MeshBasicMaterial({color:0,transparent:!0,opacity:.95,side:THREE.DoubleSide,depthTest:!1,depthWrite:!1});this.fogOfWarMesh=new THREE.Mesh(t,e),this.fogOfWarMesh.rotation.x=-Math.PI/2,this.fogOfWarMesh.position.y=.3,this.fogOfWarMesh.renderOrder=997,this.visibilityGroup.add(this.fogOfWarMesh)}},{key:"createMemoryLayer",value:function(){var t=new THREE.PlaneGeometry(1.5*this.gridSize,1.5*this.gridSize,this.gridResolution,this.gridResolution),e=new THREE.ShaderMaterial({uniforms:{opacity:{value:.7},colorInfluence:{value:.2}},vertexShader:"\n                varying vec2 vUv;\n                varying vec3 vPosition;\n                \n                void main() {\n                    vUv = uv;\n                    vPosition = position;\n                    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n                }\n            ",fragmentShader:"\n                uniform float opacity;\n                uniform float colorInfluence;\n                \n                varying vec2 vUv;\n                varying vec3 vPosition;\n                \n                void main() {\n                    // В реальной реализации здесь будет использоваться текстура с рендера сцены\n                    // Для прототипа просто делаем ЧБ эффект\n                    gl_FragColor = vec4(0.3, 0.3, 0.3, opacity);\n                }\n            ",transparent:!0,side:THREE.DoubleSide,depthTest:!1,depthWrite:!1});this.memoryMesh=new THREE.Mesh(t,e),this.memoryMesh.rotation.x=-Math.PI/2,this.memoryMesh.position.y=.2,this.memoryMesh.renderOrder=998,this.visibilityGroup.add(this.memoryMesh);for(var n=new Float32Array(t.attributes.position.count),r=0;r<n.length;r++)n[r]=0;t.setAttribute("visibility",new THREE.BufferAttribute(n,1))}},{key:"createVisionConeLayer",value:function(){var t=new THREE.Shape;t.moveTo(0,0),t.lineTo(5,5),t.lineTo(-5,5),t.lineTo(0,0);var e=new THREE.MeshBasicMaterial({color:0,side:THREE.DoubleSide,transparent:!0,opacity:.8,depthTest:!1,depthWrite:!1}),n=1.5*this.gridSize,r=new THREE.PlaneGeometry(n,n);this.visibilityMask=new THREE.Mesh(r,e),this.visibilityMask.rotation.x=-Math.PI/2,this.visibilityMask.position.y=.1,this.visibilityMask.renderOrder=999,this.visibilityGroup.add(this.visibilityMask)}},{key:"isReady",value:function(){return this.isInitialized&&this.isRapierReady&&!!this.world}},{key:"update",value:function(){if(this.isInitialized)if(this.isRapierReady){if(this.player&&this.world){var t=Date.now();if(!(this.updateInterval>0&&t-this.lastUpdateTime<this.updateInterval)){this.lastUpdateTime=t;try{var e=this.player.position,n={x:0,z:-1};"function"==typeof this.player.getViewDirection&&(n=this.player.getViewDirection());var r=this.normalFov;this.player.isAiming?r=this.aimingFov:this.player.isRunning&&(r=this.runningFov);var i=r*Math.PI/180,o=Math.atan2(n.x,n.z);this.updateVisionMask(e,o,i),this.memoryEnabled&&this.updateMemoryMap(e,o,i)}catch(t){var a=Date.now();a-this.lastErrorTime>this.errorCooldown&&(console.error("VisionSystem: ошибка при обновлении:",t),this.lastErrorTime=a)}}}}else this.checkRapierAvailability()}},{key:"updateVisionMask",value:function(t,e,n){var r=this;if(this.isRapierReady&&this.world&&t&&void 0!==e&&void 0!==n)try{var i=this.getRapierInstance();if(!i)return void console.warn("VisionSystem: RAPIER не определен при обновлении маски видимости");for(var o=n/2,a={x:t.x,y:t.y+1,z:t.z},s=[],c=0;c<this.rayCount;c++){var u=e-o+c/(this.rayCount-1)*n;s.push(u)}var l=[];l.push(new THREE.Vector2(0,0)),s.forEach((function(t){var e,n={x:Math.sin(t),y:0,z:Math.cos(t)};try{var o;if("function"==typeof i.Ray)o=new i.Ray(a,n);else{if(!i.Ray)return e={x:a.x+n.x*r.maxDistance,z:a.z+n.z*r.maxDistance},void l.push(new THREE.Vector2(e.x-a.x,e.z-a.z));o=i.Ray.new(a,n)}var s=null;if("function"==typeof r.world.castRay)s=r.world.castRay(o,r.maxDistance,!0);else if("function"==typeof r.world.castRayAndGetNormal){var c=r.world.castRayAndGetNormal(a,n,r.maxDistance,!0);s=c.hasHit?c:null}if(s){var u=("function"==typeof s.toi?s.toi():s.toi)*r.maxDistance*.99;e={x:a.x+n.x*u,z:a.z+n.z*u}}else e={x:a.x+n.x*r.maxDistance,z:a.z+n.z*r.maxDistance}}catch(t){console.error("VisionSystem: ошибка при выполнении рейкаста:",t),e={x:a.x+n.x*r.maxDistance,z:a.z+n.z*r.maxDistance}}l.push(new THREE.Vector2(e.x-a.x,e.z-a.z)),r.memoryEnabled&&r.markVisitedArea(e.x,e.z)})),l.length>1&&l.push(l[1].clone()),this.updateVisibilityShape(l,t)}catch(t){console.error("VisionSystem: ошибка при обновлении маски видимости:",t)}}},{key:"updateVisibilityShape",value:function(t,e){if(!t||t.length<3)console.warn("VisionSystem: недостаточно точек для создания формы видимости");else try{var n=new THREE.Shape;n.moveTo(t[0].x,t[0].y);for(var r=1;r<t.length;r++)n.lineTo(t[r].x,t[r].y);var i=2*this.maxDistance,o=new THREE.Shape;o.moveTo(-i,-i),o.lineTo(i,-i),o.lineTo(i,i),o.lineTo(-i,i),o.lineTo(-i,-i),o.holes.push(n),this.visibilityMask&&(this.visibilityMask.geometry&&this.visibilityMask.geometry.dispose(),this.visibilityMask.geometry=new THREE.ShapeGeometry(o),this.visibilityMask.position.set(e.x,.1,e.z))}catch(t){console.error("VisionSystem: ошибка при обновлении формы видимости:",t)}}},{key:"markVisitedArea",value:function(t,e){var n=this.gridSize/2,r=Math.floor((t+n)/this.cellSize),i=Math.floor((e+n)/this.cellSize);if(r>=0&&r<this.gridResolution&&i>=0&&i<this.gridResolution){this.memoryGrid[r][i]=1;for(var o=-1;o<=1;o++)for(var a=-1;a<=1;a++){var s=r+o,c=i+a;s>=0&&s<this.gridResolution&&c>=0&&c<this.gridResolution&&(this.memoryGrid[s][c]=Math.max(this.memoryGrid[s][c],.7))}}}},{key:"updateMemoryMap",value:function(t,e,n){if(this.memoryEnabled&&this.memoryMesh)try{this.fogOfWarMesh&&this.fogOfWarMesh.material}catch(t){console.error("VisionSystem: ошибка при обновлении карты памяти:",t)}}},{key:"setFov",value:function(t){this.fov=t}},{key:"setMaxDistance",value:function(t){this.maxDistance=t}},{key:"setRayCount",value:function(t){this.rayCount=t}},{key:"clearMemory",value:function(){if(this.memoryEnabled){for(var t=0;t<this.gridResolution;t++)for(var e=0;e<this.gridResolution;e++)this.memoryGrid[t][e]=0;console.log("VisionSystem: карта памяти очищена")}}},{key:"dispose",value:function(){try{this.visibilityMask&&(this.visibilityMask.geometry&&this.visibilityMask.geometry.dispose(),this.visibilityMask.material&&this.visibilityMask.material.dispose(),this.visibilityGroup.remove(this.visibilityMask)),this.memoryMesh&&(this.memoryMesh.geometry&&this.memoryMesh.geometry.dispose(),this.memoryMesh.material&&this.memoryMesh.material.dispose(),this.visibilityGroup.remove(this.memoryMesh)),this.fogOfWarMesh&&(this.fogOfWarMesh.geometry&&this.fogOfWarMesh.geometry.dispose(),this.fogOfWarMesh.material&&this.fogOfWarMesh.material.dispose(),this.visibilityGroup.remove(this.fogOfWarMesh)),this.visibilityGroup&&this.scene.remove(this.visibilityGroup),this.visibilityMask=null,this.memoryMesh=null,this.fogOfWarMesh=null,this.visibilityGroup=null,this.memoryGrid=[],this.isInitialized=!1,this.isRapierReady=!1,this.isRapierChecked=!1,this.initializationPromise=null,console.log("VisionSystem: ресурсы успешно освобождены")}catch(t){console.error("VisionSystem: ошибка при освобождении ресурсов:",t)}}}],e&&R(t.prototype,e),Object.defineProperty(t,"prototype",{writable:!1}),t;var t,e,n,r}();function L(t){return L="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},L(t)}function j(){j=function(){return e};var t,e={},n=Object.prototype,r=n.hasOwnProperty,i=Object.defineProperty||function(t,e,n){t[e]=n.value},o="function"==typeof Symbol?Symbol:{},a=o.iterator||"@@iterator",s=o.asyncIterator||"@@asyncIterator",c=o.toStringTag||"@@toStringTag";function u(t,e,n){return Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}),t[e]}try{u({},"")}catch(t){u=function(t,e,n){return t[e]=n}}function l(t,e,n,r){var o=e&&e.prototype instanceof v?e:v,a=Object.create(o.prototype),s=new T(r||[]);return i(a,"_invoke",{value:P(t,n,s)}),a}function h(t,e,n){try{return{type:"normal",arg:t.call(e,n)}}catch(t){return{type:"throw",arg:t}}}e.wrap=l;var f="suspendedStart",y="suspendedYield",p="executing",d="completed",m={};function v(){}function g(){}function w(){}var b={};u(b,a,(function(){return this}));var E=Object.getPrototypeOf,k=E&&E(E(I([])));k&&k!==n&&r.call(k,a)&&(b=k);var x=w.prototype=v.prototype=Object.create(b);function S(t){["next","throw","return"].forEach((function(e){u(t,e,(function(t){return this._invoke(e,t)}))}))}function R(t,e){function n(i,o,a,s){var c=h(t[i],t,o);if("throw"!==c.type){var u=c.arg,l=u.value;return l&&"object"==L(l)&&r.call(l,"__await")?e.resolve(l.__await).then((function(t){n("next",t,a,s)}),(function(t){n("throw",t,a,s)})):e.resolve(l).then((function(t){u.value=t,a(u)}),(function(t){return n("throw",t,a,s)}))}s(c.arg)}var o;i(this,"_invoke",{value:function(t,r){function i(){return new e((function(e,i){n(t,r,e,i)}))}return o=o?o.then(i,i):i()}})}function P(e,n,r){var i=f;return function(o,a){if(i===p)throw Error("Generator is already running");if(i===d){if("throw"===o)throw a;return{value:t,done:!0}}for(r.method=o,r.arg=a;;){var s=r.delegate;if(s){var c=M(s,r);if(c){if(c===m)continue;return c}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(i===f)throw i=d,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);i=p;var u=h(e,n,r);if("normal"===u.type){if(i=r.done?d:y,u.arg===m)continue;return{value:u.arg,done:r.done}}"throw"===u.type&&(i=d,r.method="throw",r.arg=u.arg)}}}function M(e,n){var r=n.method,i=e.iterator[r];if(i===t)return n.delegate=null,"throw"===r&&e.iterator.return&&(n.method="return",n.arg=t,M(e,n),"throw"===n.method)||"return"!==r&&(n.method="throw",n.arg=new TypeError("The iterator does not provide a '"+r+"' method")),m;var o=h(i,e.iterator,n.arg);if("throw"===o.type)return n.method="throw",n.arg=o.arg,n.delegate=null,m;var a=o.arg;return a?a.done?(n[e.resultName]=a.value,n.next=e.nextLoc,"return"!==n.method&&(n.method="next",n.arg=t),n.delegate=null,m):a:(n.method="throw",n.arg=new TypeError("iterator result is not an object"),n.delegate=null,m)}function O(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function C(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function T(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(O,this),this.reset(!0)}function I(e){if(e||""===e){var n=e[a];if(n)return n.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var i=-1,o=function n(){for(;++i<e.length;)if(r.call(e,i))return n.value=e[i],n.done=!1,n;return n.value=t,n.done=!0,n};return o.next=o}}throw new TypeError(L(e)+" is not iterable")}return g.prototype=w,i(x,"constructor",{value:w,configurable:!0}),i(w,"constructor",{value:g,configurable:!0}),g.displayName=u(w,c,"GeneratorFunction"),e.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===g||"GeneratorFunction"===(e.displayName||e.name))},e.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,w):(t.__proto__=w,u(t,c,"GeneratorFunction")),t.prototype=Object.create(x),t},e.awrap=function(t){return{__await:t}},S(R.prototype),u(R.prototype,s,(function(){return this})),e.AsyncIterator=R,e.async=function(t,n,r,i,o){void 0===o&&(o=Promise);var a=new R(l(t,n,r,i),o);return e.isGeneratorFunction(n)?a:a.next().then((function(t){return t.done?t.value:a.next()}))},S(x),u(x,c,"Generator"),u(x,a,(function(){return this})),u(x,"toString",(function(){return"[object Generator]"})),e.keys=function(t){var e=Object(t),n=[];for(var r in e)n.push(r);return n.reverse(),function t(){for(;n.length;){var r=n.pop();if(r in e)return t.value=r,t.done=!1,t}return t.done=!0,t}},e.values=I,T.prototype={constructor:T,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=t,this.done=!1,this.delegate=null,this.method="next",this.arg=t,this.tryEntries.forEach(C),!e)for(var n in this)"t"===n.charAt(0)&&r.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=t)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var n=this;function i(r,i){return s.type="throw",s.arg=e,n.next=r,i&&(n.method="next",n.arg=t),!!i}for(var o=this.tryEntries.length-1;o>=0;--o){var a=this.tryEntries[o],s=a.completion;if("root"===a.tryLoc)return i("end");if(a.tryLoc<=this.prev){var c=r.call(a,"catchLoc"),u=r.call(a,"finallyLoc");if(c&&u){if(this.prev<a.catchLoc)return i(a.catchLoc,!0);if(this.prev<a.finallyLoc)return i(a.finallyLoc)}else if(c){if(this.prev<a.catchLoc)return i(a.catchLoc,!0)}else{if(!u)throw Error("try statement without catch or finally");if(this.prev<a.finallyLoc)return i(a.finallyLoc)}}}},abrupt:function(t,e){for(var n=this.tryEntries.length-1;n>=0;--n){var i=this.tryEntries[n];if(i.tryLoc<=this.prev&&r.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var o=i;break}}o&&("break"===t||"continue"===t)&&o.tryLoc<=e&&e<=o.finallyLoc&&(o=null);var a=o?o.completion:{};return a.type=t,a.arg=e,o?(this.method="next",this.next=o.finallyLoc,m):this.complete(a)},complete:function(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),m},finish:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var n=this.tryEntries[e];if(n.finallyLoc===t)return this.complete(n.completion,n.afterLoc),C(n),m}},catch:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var n=this.tryEntries[e];if(n.tryLoc===t){var r=n.completion;if("throw"===r.type){var i=r.arg;C(n)}return i}}throw Error("illegal catch attempt")},delegateYield:function(e,n,r){return this.delegate={iterator:I(e),resultName:n,nextLoc:r},"next"===this.method&&(this.arg=t),m}},e}function O(t,e,n,r,i,o,a){try{var s=t[o](a),c=s.value}catch(t){return void n(t)}s.done?e(c):Promise.resolve(c).then(r,i)}function C(t){return function(){var e=this,n=arguments;return new Promise((function(r,i){var o=t.apply(e,n);function a(t){O(o,r,i,a,s,"next",t)}function s(t){O(o,r,i,a,s,"throw",t)}a(void 0)}))}}function T(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,I(r.key),r)}}function I(t){var e=function(t){if("object"!=L(t)||!t)return t;var e=t[Symbol.toPrimitive];if(void 0!==e){var n=e.call(t,"string");if("object"!=L(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==L(e)?e:e+""}var A=function(){return t=function t(e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.game=e,this.player=null,this.entities=[],this.visionSystem=null},e=[{key:"initialize",value:(r=C(j().mark((function t(){return j().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,this.createTestWalls(),this.player=new b({position:{x:0,y:0,z:0},renderer:this.game.renderer,input:this.game.input,game:this.game}),Ct("Игрок создан"),t.next=6,this.initVisionSystem();case 6:return t.abrupt("return",!0);case 9:return t.prev=9,t.t0=t.catch(0),Ct("Ошибка инициализации игрового мира: ".concat(t.t0.message)),t.abrupt("return",!1);case 13:case"end":return t.stop()}}),t,this,[[0,9]])}))),function(){return r.apply(this,arguments)})},{key:"update",value:function(t){this.player&&this.player.update(t),this.entities.forEach((function(e){e.update&&e.update(t)}))}},{key:"fixedUpdate",value:function(t){this.entities.forEach((function(e){e.fixedUpdate&&e.fixedUpdate(t)}))}},{key:"initVisionSystem",value:(n=C(j().mark((function t(){var e;return j().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(t.prev=0,this.game.renderer&&this.game.renderer.scene&&this.player){t.next=3;break}throw new Error("Не все компоненты доступны для инициализации системы видимости");case 3:return Ct("Инициализация системы видимости..."),e=new M({scene:this.game.renderer.scene,world:this.game.physics.getWorld(),player:this.player,fov:90,rayCount:60,maxDistance:50,memoryEnabled:!0,blurEdges:!0}),t.next=7,e.init();case 7:return e.isReady()||Ct("Система видимости не готова, но будет инициализирована позже автоматически"),this.game.renderer.visionSystem=e,this.visionSystem=e,Ct("Система видимости инициализирована"),t.abrupt("return",!0);case 14:return t.prev=14,t.t0=t.catch(0),Ct("Ошибка инициализации системы видимости: ".concat(t.t0.message)),t.abrupt("return",!1);case 18:case"end":return t.stop()}}),t,this,[[0,14]])}))),function(){return n.apply(this,arguments)})},{key:"createTestWalls",value:function(){var t=this;try{if(!(this.game.physics&&this.game.physics.isReady()&&this.game.renderer&&this.game.renderer.scene))return void Ct("Физика или рендерер не готовы для создания стен");Ct("Создание тестовых стен...");var e=new THREE.MeshStandardMaterial({color:8421504,roughness:.7,metalness:.2}),n=function(n,r,i,o){var a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:3,s=new THREE.BoxGeometry(i,a,o),c=new THREE.Mesh(s,e);return c.position.set(n,a/2,r),t.game.renderer.scene.add(c),t.game.physics.createObstacle({position:{x:n,y:a/2,z:r},size:{x:i,y:a,z:o},object:c}),c};n(0,-20,40,1),n(-20,0,1,40),n(20,0,1,40),n(0,20,40,1),n(-10,-10,1,20),n(10,10,20,1),n(10,-5,1,10),n(-5,5,10,1),n(-15,-15,3,3),n(15,-15,3,3),n(15,15,3,3),n(-15,15,3,3),Ct("Тестовые стены созданы")}catch(t){Ct("Ошибка создания тестовых стен: ".concat(t.message))}}},{key:"addEntity",value:function(t){this.entities.push(t)}},{key:"removeEntity",value:function(t){var e=this.entities.indexOf(t);-1!==e&&this.entities.splice(e,1)}},{key:"clear",value:function(){this.entities=[],this.player=null,this.visionSystem&&(this.visionSystem.dispose(),this.visionSystem=null),this.game.renderer&&this.game.renderer.visionSystem&&(this.game.renderer.visionSystem=null)}}],e&&T(t.prototype,e),Object.defineProperty(t,"prototype",{writable:!1}),t;var t,e,n,r}();function z(t){return z="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},z(t)}function D(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,G(r.key),r)}}function G(t){var e=function(t){if("object"!=z(t)||!t)return t;var e=t[Symbol.toPrimitive];if(void 0!==e){var n=e.call(t,"string");if("object"!=z(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==z(e)?e:e+""}var _=function(){return t=function t(e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.game=e,this.isRunning=!1,this.isLoading=!0,this.isPaused=!1,this.currentScene="loading",this.fogOfWarEnabled=!0,this.visibilitySystemEnabled=!0},(e=[{key:"togglePause",value:function(){this.isRunning?this.pauseGame():this.resumeGame()}},{key:"pauseGame",value:function(){this.isRunning=!1,this.isPaused=!0,this.game.input&&this.game.input.disableGameControls(),Ct("Игра на паузе")}},{key:"resumeGame",value:function(){this.isRunning=!0,this.isPaused=!1,this.game.input&&this.game.input.enableGameControls(),Ct("Игра возобновлена"),this.game.lastFrameTime=performance.now(),requestAnimationFrame(this.game.update)}},{key:"endGame",value:function(){this.isRunning=!1,this.currentScene="menu",this.game.world&&this.game.world.clear(),this.game.physics&&this.game.physics.dispose(),this.game.ui&&(this.game.ui.gameCanvas&&this.game.ui.gameCanvas.classList.add("hidden"),this.game.ui.hudElement&&this.game.ui.hudElement.classList.add("hidden"),this.game.ui.mainMenu&&this.game.ui.mainMenu.classList.remove("hidden")),Ct("Игра завершена")}},{key:"isInScene",value:function(t){return this.currentScene===t}}])&&D(t.prototype,e),Object.defineProperty(t,"prototype",{writable:!1}),t;var t,e}();function H(t){return H="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},H(t)}function N(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,F(r.key),r)}}function F(t){var e=function(t){if("object"!=H(t)||!t)return t;var e=t[Symbol.toPrimitive];if(void 0!==e){var n=e.call(t,"string");if("object"!=H(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==H(e)?e:e+""}var B=function(){return t=function t(e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.game=e,this.handleGlobalError=this.handleGlobalError.bind(this),this.handlePromiseError=this.handlePromiseError.bind(this),window.addEventListener("error",this.handleGlobalError),window.addEventListener("unhandledrejection",this.handlePromiseError)},e=[{key:"setupEventListeners",value:function(){var t=this;try{var e=document.getElementById("start-game");e&&e.addEventListener("click",(function(){return t.game.startGame()}));var n=document.getElementById("settings");n&&n.addEventListener("click",(function(){Ct("Настройки")}));var r=document.getElementById("close-inventory");if(r&&r.addEventListener("click",(function(){t.game.ui.hideInventory()})),this.game.input&&(this.game.input.addKeyCallback("KeyI",(function(){t.game.state.isInScene("game")&&t.game.ui.toggleInventory()})),this.game.input.addKeyCallback("Escape",(function(){t.game.state.isInScene("game")&&t.game.state.togglePause()}))),window.vkBridge)try{window.vkBridge.send("VKWebAppInit"),Ct("VK Bridge инициализирован")}catch(t){Ct("Ошибка инициализации VK Bridge: ".concat(t.message))}window.addEventListener("resize",(function(){t.game.renderer&&t.game.renderer.render(t.game.world.player)})),Ct("Обработчики событий настроены")}catch(t){throw Ct("Ошибка настройки обработчиков событий: ".concat(t.message)),t}}},{key:"handleGlobalError",value:function(t){Ct("Глобальная ошибка: ".concat(t.message," в ").concat(t.filename,":").concat(t.lineno)),this.game.state.isInScene("loading")&&this.game.ui.showErrorScreen("Ошибка: ".concat(t.message)),t.preventDefault()}},{key:"handlePromiseError",value:function(t){var e,n=(null===(e=t.reason)||void 0===e?void 0:e.message)||"Неизвестная ошибка Promise";Ct("Необработанная ошибка Promise: ".concat(n)),this.game.state.isInScene("loading")&&this.game.ui.showErrorScreen("Ошибка асинхронной операции: ".concat(n)),t.preventDefault()}}],e&&N(t.prototype,e),Object.defineProperty(t,"prototype",{writable:!1}),t;var t,e}();function V(t){return V="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},V(t)}function q(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,U(r.key),r)}}function U(t){var e=function(t){if("object"!=V(t)||!t)return t;var e=t[Symbol.toPrimitive];if(void 0!==e){var n=e.call(t,"string");if("object"!=V(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==V(e)?e:e+""}var W=function(){return t=function t(e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.canvas=e,this.scene=null,this.camera=null,this.renderer=null,this.lights=[],this.models={},this.textures={},this.visionSystem=null,this.temporaryObjects=[]},e=[{key:"setupScene",value:function(){var t=this;this.scene=new THREE.Scene,this.scene.background=new THREE.Color(8900331);var e=window.innerWidth/window.innerHeight;this.camera=new THREE.PerspectiveCamera(75,e,.1,1e3),this.camera.position.set(0,30,30),this.camera.lookAt(0,0,0),this.renderer=new THREE.WebGLRenderer({canvas:this.canvas,antialias:!0}),this.renderer.setSize(window.innerWidth,window.innerHeight),this.renderer.setPixelRatio(window.devicePixelRatio),this.renderer.shadowMap.enabled=!0,this.setupLights(),this.createGround(),this.visionSystem=null,window.addEventListener("resize",(function(){t.camera.aspect=window.innerWidth/window.innerHeight,t.camera.updateProjectionMatrix(),t.renderer.setSize(window.innerWidth,window.innerHeight)}))}},{key:"setupLights",value:function(){var t=new THREE.DirectionalLight(16777215,1);t.position.set(10,30,10),t.castShadow=!0,t.shadow.mapSize.width=2048,t.shadow.mapSize.height=2048,t.shadow.camera.near=.5,t.shadow.camera.far=100,t.shadow.camera.left=-50,t.shadow.camera.right=50,t.shadow.camera.top=50,t.shadow.camera.bottom=-50,this.scene.add(t),this.lights.push(t);var e=new THREE.AmbientLight(5263440,.7);this.scene.add(e),this.lights.push(e)}},{key:"createGround",value:function(){var t=new THREE.PlaneGeometry(1e3,1e3,100,100),e=new THREE.MeshStandardMaterial({color:4089145,roughness:1,metalness:0}),n=new THREE.Mesh(t,e);n.rotation.x=-Math.PI/2,n.position.y=-.5,n.receiveShadow=!0,this.scene.add(n)}},{key:"createTemporaryBeam",value:function(t,e){var n=this,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:16711680,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:100,o=new THREE.LineBasicMaterial({color:r,transparent:!0,opacity:.8}),a=new THREE.BufferGeometry,s=[new THREE.Vector3(t.x,t.y,t.z),new THREE.Vector3(e.x,e.y,e.z)];a.setFromPoints(s);var c=new THREE.Line(a,o);this.scene.add(c);var u={object:c,endTime:Date.now()+i};this.temporaryObjects.push(u),setTimeout((function(){n.removeTemporaryObject(u)}),i)}},{key:"removeTemporaryObject",value:function(t){if(t&&t.object){this.scene.remove(t.object);var e=this.temporaryObjects.indexOf(t);-1!==e&&this.temporaryObjects.splice(e,1),t.object.geometry&&t.object.geometry.dispose(),t.object.material&&t.object.material.dispose()}}},{key:"cleanTemporaryObjects",value:function(){var t=this,e=Date.now();this.temporaryObjects=this.temporaryObjects.filter((function(n){return!(n.endTime<=e&&(t.scene.remove(n.object),n.object.geometry&&n.object.geometry.dispose(),n.object.material&&n.object.material.dispose(),1))}))}},{key:"addPlayer",value:function(t){var e=new THREE.CylinderGeometry(.5,.5,1.8,8),n=new THREE.MeshStandardMaterial({color:2003199,roughness:.7}),r=new THREE.Mesh(e,n);r.position.copy(t.position),r.castShadow=!0,r.receiveShadow=!0;var i=new THREE.BoxGeometry(.1,.1,1),o=new THREE.MeshStandardMaterial({color:3355443,roughness:.5}),a=new THREE.Mesh(i,o);return a.position.set(.5,0,.5),r.add(a),this.scene.add(r),r}},{key:"updateCamera",value:function(t){this.camera&&(this.camera.position.x=t.x,this.camera.position.z=t.z+30,this.camera.lookAt(t.x,t.y,t.z))}},{key:"updateObjectTransform",value:function(t,e,n){t&&(e&&(t.position.x=e.x,t.position.y=e.y,t.position.z=e.z),n&&(t.rotation.y=n.y))}},{key:"render",value:function(t){this.renderer&&this.scene&&this.camera&&(this.visionSystem&&t&&this.visionSystem.update(),this.cleanTemporaryObjects(),this.renderer.render(this.scene,this.camera))}},{key:"setQuality",value:function(t){if(this.renderer)switch(t){case"low":this.renderer.setPixelRatio(1),this.renderer.shadowMap.enabled=!1;break;case"medium":this.renderer.setPixelRatio(window.devicePixelRatio),this.renderer.shadowMap.enabled=!0,this.renderer.shadowMap.type=THREE.PCFShadowMap;break;case"high":this.renderer.setPixelRatio(window.devicePixelRatio),this.renderer.shadowMap.enabled=!0,this.renderer.shadowMap.type=THREE.PCFSoftShadowMap}}},{key:"addItem",value:function(t){var e,n;switch(t.type){case"weapon":e=new THREE.BoxGeometry(.8,.3,.2),n=new THREE.MeshStandardMaterial({color:16733986});break;case"medkit":e=new THREE.BoxGeometry(.5,.3,.5),n=new THREE.MeshStandardMaterial({color:5025616});break;case"ammo":e=new THREE.BoxGeometry(.3,.3,.3),n=new THREE.MeshStandardMaterial({color:16761095});break;default:e=new THREE.SphereGeometry(.3,8,8),n=new THREE.MeshStandardMaterial({color:13421772})}var r=new THREE.Mesh(e,n);return r.position.copy(t.position),r.position.y=.2,r.castShadow=!0,r.receiveShadow=!0,this.scene.add(r),r}},{key:"addNPC",value:function(t){var e=new THREE.CylinderGeometry(.5,.5,1.8,8),n=new THREE.MeshStandardMaterial({color:"enemy"===t.type?16711680:65280,roughness:.7}),r=new THREE.Mesh(e,n);return r.position.copy(t.position),r.castShadow=!0,r.receiveShadow=!0,this.scene.add(r),r}}],e&&q(t.prototype,e),Object.defineProperty(t,"prototype",{writable:!1}),t;var t,e}();function K(t){return K="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},K(t)}function Y(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,r)}return n}function Q(t,e,n){return(e=$(e))in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function X(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,$(r.key),r)}}function $(t){var e=function(t){if("object"!=K(t)||!t)return t;var e=t[Symbol.toPrimitive];if(void 0!==e){var n=e.call(t,"string");if("object"!=K(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==K(e)?e:e+""}var J=function(){return t=function t(){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.keys={},this.mouse={position:{x:0,y:0},isDown:!1,rightIsDown:!1},this.lastMousePosition={x:0,y:0},this.keyCallbacks={},this.clickCallback=null,this.rightClickCallback=null,this.mouseMoveCallback=null,this.mouseDownCallback=null,this.mouseUpCallback=null,this.gameControlsEnabled=!0,this.mouseSensitivity=1,this.handleKeyDown=this.handleKeyDown.bind(this),this.handleKeyUp=this.handleKeyUp.bind(this),this.handleMouseMove=this.handleMouseMove.bind(this),this.handleMouseDown=this.handleMouseDown.bind(this),this.handleMouseUp=this.handleMouseUp.bind(this),this.handleContextMenu=this.handleContextMenu.bind(this),this.init()},e=[{key:"init",value:function(){window.addEventListener("keydown",this.handleKeyDown),window.addEventListener("keyup",this.handleKeyUp),window.addEventListener("mousemove",this.handleMouseMove),window.addEventListener("mousedown",this.handleMouseDown),window.addEventListener("mouseup",this.handleMouseUp),window.addEventListener("contextmenu",this.handleContextMenu),document.body.style.userSelect="none"}},{key:"handleKeyDown",value:function(t){this.keys[t.code]=!0,this.keyCallbacks[t.code]&&this.gameControlsEnabled&&this.keyCallbacks[t.code]()}},{key:"handleKeyUp",value:function(t){this.keys[t.code]=!1}},{key:"handleMouseMove",value:function(t){this.mouse.position.x=t.clientX,this.mouse.position.y=t.clientY;var e=(this.mouse.position.x-this.lastMousePosition.x)*this.mouseSensitivity,n=(this.mouse.position.y-this.lastMousePosition.y)*this.mouseSensitivity;this.lastMousePosition.x=this.mouse.position.x,this.lastMousePosition.y=this.mouse.position.y,this.mouseMoveCallback&&this.gameControlsEnabled&&this.mouseMoveCallback(this.mouse.position,{x:e,y:n})}},{key:"handleMouseDown",value:function(t){0===t.button?(this.mouse.isDown=!0,this.mouseDownCallback&&this.gameControlsEnabled&&this.mouseDownCallback(0,this.mouse.position),this.clickCallback&&this.gameControlsEnabled&&this.clickCallback(this.mouse.position)):2===t.button&&(this.mouse.rightIsDown=!0,this.mouseDownCallback&&this.gameControlsEnabled&&this.mouseDownCallback(2,this.mouse.position),this.rightClickCallback&&this.gameControlsEnabled&&this.rightClickCallback(this.mouse.position))}},{key:"handleMouseUp",value:function(t){0===t.button?(this.mouse.isDown=!1,this.mouseUpCallback&&this.gameControlsEnabled&&this.mouseUpCallback(0)):2===t.button&&(this.mouse.rightIsDown=!1,this.mouseUpCallback&&this.gameControlsEnabled&&this.mouseUpCallback(2))}},{key:"handleContextMenu",value:function(t){t.preventDefault()}},{key:"isKeyPressed",value:function(t){return this.gameControlsEnabled&&!0===this.keys[t]}},{key:"isMouseDown",value:function(){return this.gameControlsEnabled&&this.mouse.isDown}},{key:"isRightMouseDown",value:function(){return this.gameControlsEnabled&&this.mouse.rightIsDown}},{key:"getMousePosition",value:function(){return function(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?Y(Object(n),!0).forEach((function(e){Q(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):Y(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}({},this.mouse.position)}},{key:"setMouseSensitivity",value:function(t){this.mouseSensitivity=t}},{key:"addKeyCallback",value:function(t,e){this.keyCallbacks[t]=e}},{key:"removeKeyCallback",value:function(t){delete this.keyCallbacks[t]}},{key:"setClickCallback",value:function(t){this.clickCallback=t}},{key:"setRightClickCallback",value:function(t){this.rightClickCallback=t}},{key:"setMouseMoveCallback",value:function(t){this.mouseMoveCallback=t}},{key:"setMouseDownCallback",value:function(t){this.mouseDownCallback=t}},{key:"setMouseUpCallback",value:function(t){this.mouseUpCallback=t}},{key:"disableGameControls",value:function(){this.gameControlsEnabled=!1}},{key:"enableGameControls",value:function(){this.gameControlsEnabled=!0}},{key:"getMovementDirection",value:function(){if(!this.gameControlsEnabled)return{x:0,z:0};var t=0,e=0;return this.isKeyPressed("KeyW")||this.isKeyPressed("ArrowUp")?e=-1:(this.isKeyPressed("KeyS")||this.isKeyPressed("ArrowDown"))&&(e=1),this.isKeyPressed("KeyA")||this.isKeyPressed("ArrowLeft")?t=-1:(this.isKeyPressed("KeyD")||this.isKeyPressed("ArrowRight"))&&(t=1),{x:t,z:e}}},{key:"clearCallbacks",value:function(){this.keyCallbacks={},this.clickCallback=null,this.rightClickCallback=null,this.mouseMoveCallback=null,this.mouseDownCallback=null,this.mouseUpCallback=null}},{key:"destroy",value:function(){window.removeEventListener("keydown",this.handleKeyDown),window.removeEventListener("keyup",this.handleKeyUp),window.removeEventListener("mousemove",this.handleMouseMove),window.removeEventListener("mousedown",this.handleMouseDown),window.removeEventListener("mouseup",this.handleMouseUp),window.removeEventListener("contextmenu",this.handleContextMenu),document.body.style.userSelect=""}}],e&&X(t.prototype,e),Object.defineProperty(t,"prototype",{writable:!1}),t;var t,e}();function Z(t){return Z="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},Z(t)}function tt(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,r)}return n}function et(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?tt(Object(n),!0).forEach((function(e){nt(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):tt(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}function nt(t,e,n){return(e=it(e))in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function rt(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,it(r.key),r)}}function it(t){var e=function(t){if("object"!=Z(t)||!t)return t;var e=t[Symbol.toPrimitive];if(void 0!==e){var n=e.call(t,"string");if("object"!=Z(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==Z(e)?e:e+""}var ot=function(){return t=function t(){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.socket=null,this.connected=!1,this.serverUrl="wss://your-server-url.com",this.mockMode=!0,this.eventHandlers={connect:[],disconnect:[],error:[],message:[],playerMove:[],playerShoot:[],playerDamage:[],itemPickup:[],npcSpawn:[],npcMove:[],gameState:[]},this.mockData={players:{},npcs:{},items:{}},this.playerId="local_player"},(e=[{key:"connect",value:function(){var t=this;return new Promise((function(e){console.log("Запущен режим прототипа (без сервера)"),t.connected=!0,t.generateMockData(),setTimeout((function(){t.eventHandlers.connect.forEach((function(t){return t()})),t.startMockNpcMovement(),e()}),500)}))}},{key:"generateMockData",value:function(){for(var t=0;t<15;t++){var e="item_".concat(t),n=80*(Math.random()-.5),r=80*(Math.random()-.5),i=["weapon","medkit","ammo"],o=i[Math.floor(Math.random()*i.length)];this.mockData.items[e]={id:e,type:o,position:{x:n,y:0,z:r},properties:{}}}for(var a=0;a<5;a++){var s="npc_".concat(a),c=80*(Math.random()-.5),u=80*(Math.random()-.5);this.mockData.npcs[s]={id:s,type:"enemy",position:{x:c,y:0,z:u},health:100,state:"patrol"}}}},{key:"startMockNpcMovement",value:function(){var t=this;setInterval((function(){Object.keys(t.mockData.npcs).forEach((function(e){var n=t.mockData.npcs[e],r=2*(Math.random()-.5),i=2*(Math.random()-.5);n.position.x+=r,n.position.z+=i,n.position.x=Math.max(-45,Math.min(45,n.position.x)),n.position.z=Math.max(-45,Math.min(45,n.position.z)),t.eventHandlers.npcMove.forEach((function(t){return t({id:e,position:n.position})}))}))}),1e3)}},{key:"on",value:function(t,e){this.eventHandlers[t]&&this.eventHandlers[t].push(e)}},{key:"sendPlayerMove",value:function(t,e){this.connected&&this.mockMode&&(this.mockData.players[this.playerId]=et(et({},this.mockData.players[this.playerId]),{},{position:t,rotation:e}))}},{key:"sendPlayerShoot",value:function(t,e,n){this.connected&&console.log("Выстрел игрока:",{position:t,direction:e,weapon:n})}},{key:"sendItemPickup",value:function(t,e){this.connected&&(console.log("Подбор предмета:",{itemId:t,itemType:e}),this.mockMode&&delete this.mockData.items[t])}}])&&rt(t.prototype,e),Object.defineProperty(t,"prototype",{writable:!1}),t;var t,e}();function at(t){return at="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},at(t)}function st(){st=function(){return e};var t,e={},n=Object.prototype,r=n.hasOwnProperty,i=Object.defineProperty||function(t,e,n){t[e]=n.value},o="function"==typeof Symbol?Symbol:{},a=o.iterator||"@@iterator",s=o.asyncIterator||"@@asyncIterator",c=o.toStringTag||"@@toStringTag";function u(t,e,n){return Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}),t[e]}try{u({},"")}catch(t){u=function(t,e,n){return t[e]=n}}function l(t,e,n,r){var o=e&&e.prototype instanceof v?e:v,a=Object.create(o.prototype),s=new O(r||[]);return i(a,"_invoke",{value:P(t,n,s)}),a}function h(t,e,n){try{return{type:"normal",arg:t.call(e,n)}}catch(t){return{type:"throw",arg:t}}}e.wrap=l;var f="suspendedStart",y="suspendedYield",p="executing",d="completed",m={};function v(){}function g(){}function w(){}var b={};u(b,a,(function(){return this}));var E=Object.getPrototypeOf,k=E&&E(E(C([])));k&&k!==n&&r.call(k,a)&&(b=k);var x=w.prototype=v.prototype=Object.create(b);function S(t){["next","throw","return"].forEach((function(e){u(t,e,(function(t){return this._invoke(e,t)}))}))}function R(t,e){function n(i,o,a,s){var c=h(t[i],t,o);if("throw"!==c.type){var u=c.arg,l=u.value;return l&&"object"==at(l)&&r.call(l,"__await")?e.resolve(l.__await).then((function(t){n("next",t,a,s)}),(function(t){n("throw",t,a,s)})):e.resolve(l).then((function(t){u.value=t,a(u)}),(function(t){return n("throw",t,a,s)}))}s(c.arg)}var o;i(this,"_invoke",{value:function(t,r){function i(){return new e((function(e,i){n(t,r,e,i)}))}return o=o?o.then(i,i):i()}})}function P(e,n,r){var i=f;return function(o,a){if(i===p)throw Error("Generator is already running");if(i===d){if("throw"===o)throw a;return{value:t,done:!0}}for(r.method=o,r.arg=a;;){var s=r.delegate;if(s){var c=M(s,r);if(c){if(c===m)continue;return c}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(i===f)throw i=d,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);i=p;var u=h(e,n,r);if("normal"===u.type){if(i=r.done?d:y,u.arg===m)continue;return{value:u.arg,done:r.done}}"throw"===u.type&&(i=d,r.method="throw",r.arg=u.arg)}}}function M(e,n){var r=n.method,i=e.iterator[r];if(i===t)return n.delegate=null,"throw"===r&&e.iterator.return&&(n.method="return",n.arg=t,M(e,n),"throw"===n.method)||"return"!==r&&(n.method="throw",n.arg=new TypeError("The iterator does not provide a '"+r+"' method")),m;var o=h(i,e.iterator,n.arg);if("throw"===o.type)return n.method="throw",n.arg=o.arg,n.delegate=null,m;var a=o.arg;return a?a.done?(n[e.resultName]=a.value,n.next=e.nextLoc,"return"!==n.method&&(n.method="next",n.arg=t),n.delegate=null,m):a:(n.method="throw",n.arg=new TypeError("iterator result is not an object"),n.delegate=null,m)}function L(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function j(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function O(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(L,this),this.reset(!0)}function C(e){if(e||""===e){var n=e[a];if(n)return n.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var i=-1,o=function n(){for(;++i<e.length;)if(r.call(e,i))return n.value=e[i],n.done=!1,n;return n.value=t,n.done=!0,n};return o.next=o}}throw new TypeError(at(e)+" is not iterable")}return g.prototype=w,i(x,"constructor",{value:w,configurable:!0}),i(w,"constructor",{value:g,configurable:!0}),g.displayName=u(w,c,"GeneratorFunction"),e.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===g||"GeneratorFunction"===(e.displayName||e.name))},e.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,w):(t.__proto__=w,u(t,c,"GeneratorFunction")),t.prototype=Object.create(x),t},e.awrap=function(t){return{__await:t}},S(R.prototype),u(R.prototype,s,(function(){return this})),e.AsyncIterator=R,e.async=function(t,n,r,i,o){void 0===o&&(o=Promise);var a=new R(l(t,n,r,i),o);return e.isGeneratorFunction(n)?a:a.next().then((function(t){return t.done?t.value:a.next()}))},S(x),u(x,c,"Generator"),u(x,a,(function(){return this})),u(x,"toString",(function(){return"[object Generator]"})),e.keys=function(t){var e=Object(t),n=[];for(var r in e)n.push(r);return n.reverse(),function t(){for(;n.length;){var r=n.pop();if(r in e)return t.value=r,t.done=!1,t}return t.done=!0,t}},e.values=C,O.prototype={constructor:O,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=t,this.done=!1,this.delegate=null,this.method="next",this.arg=t,this.tryEntries.forEach(j),!e)for(var n in this)"t"===n.charAt(0)&&r.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=t)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var n=this;function i(r,i){return s.type="throw",s.arg=e,n.next=r,i&&(n.method="next",n.arg=t),!!i}for(var o=this.tryEntries.length-1;o>=0;--o){var a=this.tryEntries[o],s=a.completion;if("root"===a.tryLoc)return i("end");if(a.tryLoc<=this.prev){var c=r.call(a,"catchLoc"),u=r.call(a,"finallyLoc");if(c&&u){if(this.prev<a.catchLoc)return i(a.catchLoc,!0);if(this.prev<a.finallyLoc)return i(a.finallyLoc)}else if(c){if(this.prev<a.catchLoc)return i(a.catchLoc,!0)}else{if(!u)throw Error("try statement without catch or finally");if(this.prev<a.finallyLoc)return i(a.finallyLoc)}}}},abrupt:function(t,e){for(var n=this.tryEntries.length-1;n>=0;--n){var i=this.tryEntries[n];if(i.tryLoc<=this.prev&&r.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var o=i;break}}o&&("break"===t||"continue"===t)&&o.tryLoc<=e&&e<=o.finallyLoc&&(o=null);var a=o?o.completion:{};return a.type=t,a.arg=e,o?(this.method="next",this.next=o.finallyLoc,m):this.complete(a)},complete:function(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),m},finish:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var n=this.tryEntries[e];if(n.finallyLoc===t)return this.complete(n.completion,n.afterLoc),j(n),m}},catch:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var n=this.tryEntries[e];if(n.tryLoc===t){var r=n.completion;if("throw"===r.type){var i=r.arg;j(n)}return i}}throw Error("illegal catch attempt")},delegateYield:function(e,n,r){return this.delegate={iterator:C(e),resultName:n,nextLoc:r},"next"===this.method&&(this.arg=t),m}},e}function ct(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function ut(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,ht(r.key),r)}}function lt(t,e,n){return e&&ut(t.prototype,e),n&&ut(t,n),Object.defineProperty(t,"prototype",{writable:!1}),t}function ht(t){var e=function(t){if("object"!=at(t)||!t)return t;var e=t[Symbol.toPrimitive];if(void 0!==e){var n=e.call(t,"string");if("object"!=at(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==at(e)?e:e+""}function ft(t,e,n,r,i,o,a){try{var s=t[o](a),c=s.value}catch(t){return void n(t)}s.done?e(c):Promise.resolve(c).then(r,i)}function yt(){return pt.apply(this,arguments)}function pt(){var t;return t=st().mark((function t(){var e;return st().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(console.log("Начинаем инициализацию Rapier.js..."),"undefined"==typeof RAPIER){t.next=4;break}return console.log("Rapier.js уже загружен из глобального объекта"),t.abrupt("return",RAPIER);case 4:if(t.prev=4,"undefined"==typeof window||!window.RAPIER){t.next=8;break}return console.log("Используем Rapier.js из window.RAPIER"),t.abrupt("return",window.RAPIER);case 8:if("undefined"==typeof RAPIER||"function"!=typeof RAPIER.init){t.next=13;break}return console.log("Инициализируем Rapier.js через RAPIER.init()"),t.next=12,RAPIER.init();case 12:return t.abrupt("return",RAPIER);case 13:throw new Error("Rapier.js не найден в глобальном пространстве имен");case 16:return t.prev=16,t.t0=t.catch(4),console.warn("Не удалось инициализировать Rapier.js из глобального пространства:",t.t0),t.prev=19,console.log("Пытаемся дождаться загрузки Rapier.js..."),e=new Promise((function(t,e){var n=0,r=function(){if(n++,void 0!==window.RAPIER)return console.log("RAPIER найден после ".concat(n," попыток")),void t(window.RAPIER);n>=10?e(new Error("RAPIER не загрузился после ".concat(10," попыток"))):setTimeout(r,300)};r()})),t.next=24,e;case 24:return t.abrupt("return",t.sent);case 27:return t.prev=27,t.t1=t.catch(19),console.error("Все попытки инициализации Rapier.js завершились неудачей:",t.t1),t.abrupt("return",(console.warn("Создание заглушки Rapier.js. Физика НЕ будет работать корректно!"),{World:function(){return lt((function t(){ct(this,t),console.warn("Используется заглушка World вместо настоящего Rapier.js"),this.bodies=[],this.colliders=[]}),[{key:"step",value:function(){}},{key:"createRigidBody",value:function(){return{translation:function(){return{x:0,y:0,z:0}},setTranslation:function(){}}}},{key:"createCollider",value:function(){return{}}},{key:"castRay",value:function(){return null}},{key:"castRayAndGetNormal",value:function(){return{hasHit:!1,toi:0}}}])}(),RigidBodyDesc:{fixed:function(){return{setTranslation:function(){return{}}}},dynamic:function(){return{setTranslation:function(){return{}},setCanSleep:function(){return{}},setLinearDamping:function(){return{}}}}},ColliderDesc:{cuboid:function(){return{}},capsule:function(){return{}}},Ray:lt((function t(e,n){ct(this,t),this.origin=e,this.dir=n}))}));case 31:case"end":return t.stop()}}),t,null,[[4,16],[19,27]])})),pt=function(){var e=this,n=arguments;return new Promise((function(r,i){var o=t.apply(e,n);function a(t){ft(o,r,i,a,s,"next",t)}function s(t){ft(o,r,i,a,s,"throw",t)}a(void 0)}))},pt.apply(this,arguments)}function dt(t){return dt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},dt(t)}function mt(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){var n=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=n){var r,i,o,a,s=[],c=!0,u=!1;try{if(o=(n=n.call(t)).next,0===e){if(Object(n)!==n)return;c=!1}else for(;!(c=(r=o.call(n)).done)&&(s.push(r.value),s.length!==e);c=!0);}catch(t){u=!0,i=t}finally{try{if(!c&&null!=n.return&&(a=n.return(),Object(a)!==a))return}finally{if(u)throw i}}return s}}(t,e)||vt(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function vt(t,e){if(t){if("string"==typeof t)return gt(t,e);var n={}.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?gt(t,e):void 0}}function gt(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,r=Array(e);n<e;n++)r[n]=t[n];return r}function wt(){wt=function(){return e};var t,e={},n=Object.prototype,r=n.hasOwnProperty,i=Object.defineProperty||function(t,e,n){t[e]=n.value},o="function"==typeof Symbol?Symbol:{},a=o.iterator||"@@iterator",s=o.asyncIterator||"@@asyncIterator",c=o.toStringTag||"@@toStringTag";function u(t,e,n){return Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}),t[e]}try{u({},"")}catch(t){u=function(t,e,n){return t[e]=n}}function l(t,e,n,r){var o=e&&e.prototype instanceof v?e:v,a=Object.create(o.prototype),s=new O(r||[]);return i(a,"_invoke",{value:P(t,n,s)}),a}function h(t,e,n){try{return{type:"normal",arg:t.call(e,n)}}catch(t){return{type:"throw",arg:t}}}e.wrap=l;var f="suspendedStart",y="suspendedYield",p="executing",d="completed",m={};function v(){}function g(){}function w(){}var b={};u(b,a,(function(){return this}));var E=Object.getPrototypeOf,k=E&&E(E(C([])));k&&k!==n&&r.call(k,a)&&(b=k);var x=w.prototype=v.prototype=Object.create(b);function S(t){["next","throw","return"].forEach((function(e){u(t,e,(function(t){return this._invoke(e,t)}))}))}function R(t,e){function n(i,o,a,s){var c=h(t[i],t,o);if("throw"!==c.type){var u=c.arg,l=u.value;return l&&"object"==dt(l)&&r.call(l,"__await")?e.resolve(l.__await).then((function(t){n("next",t,a,s)}),(function(t){n("throw",t,a,s)})):e.resolve(l).then((function(t){u.value=t,a(u)}),(function(t){return n("throw",t,a,s)}))}s(c.arg)}var o;i(this,"_invoke",{value:function(t,r){function i(){return new e((function(e,i){n(t,r,e,i)}))}return o=o?o.then(i,i):i()}})}function P(e,n,r){var i=f;return function(o,a){if(i===p)throw Error("Generator is already running");if(i===d){if("throw"===o)throw a;return{value:t,done:!0}}for(r.method=o,r.arg=a;;){var s=r.delegate;if(s){var c=M(s,r);if(c){if(c===m)continue;return c}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(i===f)throw i=d,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);i=p;var u=h(e,n,r);if("normal"===u.type){if(i=r.done?d:y,u.arg===m)continue;return{value:u.arg,done:r.done}}"throw"===u.type&&(i=d,r.method="throw",r.arg=u.arg)}}}function M(e,n){var r=n.method,i=e.iterator[r];if(i===t)return n.delegate=null,"throw"===r&&e.iterator.return&&(n.method="return",n.arg=t,M(e,n),"throw"===n.method)||"return"!==r&&(n.method="throw",n.arg=new TypeError("The iterator does not provide a '"+r+"' method")),m;var o=h(i,e.iterator,n.arg);if("throw"===o.type)return n.method="throw",n.arg=o.arg,n.delegate=null,m;var a=o.arg;return a?a.done?(n[e.resultName]=a.value,n.next=e.nextLoc,"return"!==n.method&&(n.method="next",n.arg=t),n.delegate=null,m):a:(n.method="throw",n.arg=new TypeError("iterator result is not an object"),n.delegate=null,m)}function L(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function j(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function O(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(L,this),this.reset(!0)}function C(e){if(e||""===e){var n=e[a];if(n)return n.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var i=-1,o=function n(){for(;++i<e.length;)if(r.call(e,i))return n.value=e[i],n.done=!1,n;return n.value=t,n.done=!0,n};return o.next=o}}throw new TypeError(dt(e)+" is not iterable")}return g.prototype=w,i(x,"constructor",{value:w,configurable:!0}),i(w,"constructor",{value:g,configurable:!0}),g.displayName=u(w,c,"GeneratorFunction"),e.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===g||"GeneratorFunction"===(e.displayName||e.name))},e.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,w):(t.__proto__=w,u(t,c,"GeneratorFunction")),t.prototype=Object.create(x),t},e.awrap=function(t){return{__await:t}},S(R.prototype),u(R.prototype,s,(function(){return this})),e.AsyncIterator=R,e.async=function(t,n,r,i,o){void 0===o&&(o=Promise);var a=new R(l(t,n,r,i),o);return e.isGeneratorFunction(n)?a:a.next().then((function(t){return t.done?t.value:a.next()}))},S(x),u(x,c,"Generator"),u(x,a,(function(){return this})),u(x,"toString",(function(){return"[object Generator]"})),e.keys=function(t){var e=Object(t),n=[];for(var r in e)n.push(r);return n.reverse(),function t(){for(;n.length;){var r=n.pop();if(r in e)return t.value=r,t.done=!1,t}return t.done=!0,t}},e.values=C,O.prototype={constructor:O,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=t,this.done=!1,this.delegate=null,this.method="next",this.arg=t,this.tryEntries.forEach(j),!e)for(var n in this)"t"===n.charAt(0)&&r.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=t)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var n=this;function i(r,i){return s.type="throw",s.arg=e,n.next=r,i&&(n.method="next",n.arg=t),!!i}for(var o=this.tryEntries.length-1;o>=0;--o){var a=this.tryEntries[o],s=a.completion;if("root"===a.tryLoc)return i("end");if(a.tryLoc<=this.prev){var c=r.call(a,"catchLoc"),u=r.call(a,"finallyLoc");if(c&&u){if(this.prev<a.catchLoc)return i(a.catchLoc,!0);if(this.prev<a.finallyLoc)return i(a.finallyLoc)}else if(c){if(this.prev<a.catchLoc)return i(a.catchLoc,!0)}else{if(!u)throw Error("try statement without catch or finally");if(this.prev<a.finallyLoc)return i(a.finallyLoc)}}}},abrupt:function(t,e){for(var n=this.tryEntries.length-1;n>=0;--n){var i=this.tryEntries[n];if(i.tryLoc<=this.prev&&r.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var o=i;break}}o&&("break"===t||"continue"===t)&&o.tryLoc<=e&&e<=o.finallyLoc&&(o=null);var a=o?o.completion:{};return a.type=t,a.arg=e,o?(this.method="next",this.next=o.finallyLoc,m):this.complete(a)},complete:function(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),m},finish:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var n=this.tryEntries[e];if(n.finallyLoc===t)return this.complete(n.completion,n.afterLoc),j(n),m}},catch:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var n=this.tryEntries[e];if(n.tryLoc===t){var r=n.completion;if("throw"===r.type){var i=r.arg;j(n)}return i}}throw Error("illegal catch attempt")},delegateYield:function(e,n,r){return this.delegate={iterator:C(e),resultName:n,nextLoc:r},"next"===this.method&&(this.arg=t),m}},e}function bt(t,e,n,r,i,o,a){try{var s=t[o](a),c=s.value}catch(t){return void n(t)}s.done?e(c):Promise.resolve(c).then(r,i)}function Et(t){return function(){var e=this,n=arguments;return new Promise((function(r,i){var o=t.apply(e,n);function a(t){bt(o,r,i,a,s,"next",t)}function s(t){bt(o,r,i,a,s,"throw",t)}a(void 0)}))}}function kt(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,xt(r.key),r)}}function xt(t){var e=function(t){if("object"!=dt(t)||!t)return t;var e=t[Symbol.toPrimitive];if(void 0!==e){var n=e.call(t,"string");if("object"!=dt(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==dt(e)?e:e+""}var St=function(){return t=function t(){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.world=null,this.bodies=new Map,this.colliders=new Map,this.isInitialized=!1,this.RAPIER=null,this.initPromise=null},e=[{key:"init",value:(n=Et(wt().mark((function t(){var e=this;return wt().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!this.initPromise){t.next=2;break}return t.abrupt("return",this.initPromise);case 2:return this.initPromise=new Promise(function(){var t=Et(wt().mark((function t(n){var r,i;return wt().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,console.log("PhysicsManager: начало инициализации..."),t.next=4,yt();case 4:if(e.RAPIER=t.sent,e.RAPIER||"undefined"!=typeof RAPIER||"undefined"!=typeof window&&window.RAPIER){t.next=9;break}return console.error("PhysicsManager: RAPIER не определен. Убедитесь, что библиотека загружена."),n(!1),t.abrupt("return");case 9:if(e.RAPIER){t.next=15;break}if(e.RAPIER="undefined"!=typeof RAPIER?RAPIER:"undefined"!=typeof window&&window.RAPIER?window.RAPIER:null,e.RAPIER){t.next=15;break}return console.error("PhysicsManager: не удалось получить объект RAPIER."),n(!1),t.abrupt("return");case 15:if(console.log("PhysicsManager: создание физического мира..."),i={x:0,y:-9.81,z:0},"function"!=typeof e.RAPIER.World){t.next=21;break}e.world=new e.RAPIER.World(i),t.next=28;break;case 21:if("function"!=typeof(null===(r=e.RAPIER.World)||void 0===r?void 0:r.new)){t.next=25;break}e.world=e.RAPIER.World.new(i),t.next=28;break;case 25:return console.error("PhysicsManager: не удалось создать физический мир. Неподдерживаемый API."),n(!1),t.abrupt("return");case 28:e.isInitialized=!0,console.log("PhysicsManager: физический движок успешно инициализирован."),n(!0),t.next=38;break;case 33:t.prev=33,t.t0=t.catch(0),console.error("PhysicsManager: ошибка при инициализации физики:",t.t0),e.isInitialized=!1,n(!1);case 38:case"end":return t.stop()}}),t,null,[[0,33]])})));return function(e){return t.apply(this,arguments)}}()),t.abrupt("return",this.initPromise);case 4:case"end":return t.stop()}}),t,this)}))),function(){return n.apply(this,arguments)})},{key:"isReady",value:function(){return this.isInitialized&&null!==this.world}},{key:"getWorld",value:function(){return this.world}},{key:"update",value:function(t){if(this.isReady())try{"function"==typeof this.world.step?this.world.step():"function"==typeof this.world.timestep&&this.world.timestep(t||1/60),this.updateBodies()}catch(t){console.error("PhysicsManager: ошибка при обновлении физики:",t)}}},{key:"updateBodies",value:function(){try{var t,e=function(t){var e="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!e){if(Array.isArray(t)||(e=vt(t))){e&&(t=e);var n=0,r=function(){};return{s:r,n:function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}},e:function(t){throw t},f:r}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,o=!0,a=!1;return{s:function(){e=e.call(t)},n:function(){var t=e.next();return o=t.done,t},e:function(t){a=!0,i=t},f:function(){try{o||null==e.return||e.return()}finally{if(a)throw i}}}}(this.bodies);try{for(e.s();!(t=e.n()).done;){var n=mt(t.value,2),r=n[0],i=n[1];if(r&&r.position&&i){var o=void 0;if("function"==typeof i.translation)o=i.translation();else if("function"==typeof i.getTranslation)o=i.getTranslation();else{if(!i.translation)continue;o=i.translation}r.position.set(o.x,o.y,o.z),"function"==typeof r.updatePhysics&&r.updatePhysics(i)}}}catch(t){e.e(t)}finally{e.f()}}catch(t){console.error("PhysicsManager: ошибка при обновлении позиций объектов:",t)}}},{key:"createObstacle",value:function(t){if(!this.isReady())return null;try{var e,n=t.position||{x:0,y:0,z:0},r=t.size||{x:1,y:1,z:1};"function"==typeof this.RAPIER.RigidBodyDesc.fixed?e=this.RAPIER.RigidBodyDesc.fixed().setTranslation(n.x,n.y,n.z):(e=new this.RAPIER.RigidBodyDesc(this.RAPIER.RigidBodyType.Fixed)).translation={x:n.x,y:n.y,z:n.z};var i,o=this.world.createRigidBody(e);i="function"==typeof this.RAPIER.ColliderDesc.cuboid?this.RAPIER.ColliderDesc.cuboid(r.x/2,r.y/2,r.z/2):new this.RAPIER.ColliderDesc(new this.RAPIER.Cuboid(r.x/2,r.y/2,r.z/2));var a=this.world.createCollider(i,o);return t.object&&(this.bodies.set(t.object,o),this.colliders.set(t.object,a)),a}catch(t){return console.error("PhysicsManager: ошибка при создании препятствия:",t),null}}},{key:"createCharacter",value:function(t){if(!this.isReady())return null;try{var e,n=t.position||{x:0,y:0,z:0},r=t.radius||.5,i=t.height||1.8;"function"==typeof this.RAPIER.RigidBodyDesc.dynamic?e=this.RAPIER.RigidBodyDesc.dynamic().setTranslation(n.x,n.y,n.z).setCanSleep(!1).setLinearDamping(.2):((e=new this.RAPIER.RigidBodyDesc(this.RAPIER.RigidBodyType.Dynamic)).translation={x:n.x,y:n.y,z:n.z},e.canSleep=!1,e.linearDamping=.2);var o,a=this.world.createRigidBody(e);o="function"==typeof this.RAPIER.ColliderDesc.capsule?this.RAPIER.ColliderDesc.capsule(i/2-r,r):new this.RAPIER.ColliderDesc(new this.RAPIER.Capsule(i/2-r,r));var s=this.world.createCollider(o,a);return t.object&&(this.bodies.set(t.object,a),this.colliders.set(t.object,s)),a}catch(t){return console.error("PhysicsManager: ошибка при создании персонажа:",t),null}}},{key:"castRay",value:function(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:100;if(!this.isReady())return null;try{var r;return r="function"==typeof this.RAPIER.Ray?new this.RAPIER.Ray(t,e):{origin:t,direction:e},"function"==typeof this.world.castRay?this.world.castRay(r,n,!0):"function"==typeof this.world.castRayAndGetNormal?this.world.castRayAndGetNormal(t,e,n,!0):(console.warn("PhysicsManager: метод рейкаста не доступен"),null)}catch(t){return console.error("PhysicsManager: ошибка при выполнении рейкаста:",t),null}}},{key:"createGround",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(!this.isReady())return null;try{var e,n=t.normal||{x:0,y:1,z:0},r=t.offset||0;e="function"==typeof this.RAPIER.RigidBodyDesc.fixed?this.RAPIER.RigidBodyDesc.fixed():new this.RAPIER.RigidBodyDesc(this.RAPIER.RigidBodyType.Fixed);var i,o=this.world.createRigidBody(e);return i="function"==typeof this.RAPIER.ColliderDesc.halfspace?this.RAPIER.ColliderDesc.halfspace(n,r):new this.RAPIER.ColliderDesc(new this.RAPIER.HalfSpace(n,r)),this.world.createCollider(i,o)}catch(t){return console.error("PhysicsManager: ошибка при создании плоскости:",t),null}}},{key:"removeBody",value:function(t){try{if(this.bodies.has(t)){var e=this.bodies.get(t);this.world.removeRigidBody(e),this.bodies.delete(t)}this.colliders.has(t)&&this.colliders.delete(t)}catch(t){console.error("PhysicsManager: ошибка при удалении тела:",t)}}},{key:"dispose",value:function(){try{this.bodies.clear(),this.colliders.clear(),this.world&&("function"==typeof this.world.free&&this.world.free(),this.world=null),this.isInitialized=!1,this.initPromise=null,console.log("PhysicsManager: ресурсы освобождены")}catch(t){console.error("PhysicsManager: ошибка при освобождении ресурсов:",t)}}}],e&&kt(t.prototype,e),Object.defineProperty(t,"prototype",{writable:!1}),t;var t,e,n}();function Rt(t){return Rt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},Rt(t)}function Pt(){Pt=function(){return e};var t,e={},n=Object.prototype,r=n.hasOwnProperty,i=Object.defineProperty||function(t,e,n){t[e]=n.value},o="function"==typeof Symbol?Symbol:{},a=o.iterator||"@@iterator",s=o.asyncIterator||"@@asyncIterator",c=o.toStringTag||"@@toStringTag";function u(t,e,n){return Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}),t[e]}try{u({},"")}catch(t){u=function(t,e,n){return t[e]=n}}function l(t,e,n,r){var o=e&&e.prototype instanceof v?e:v,a=Object.create(o.prototype),s=new O(r||[]);return i(a,"_invoke",{value:P(t,n,s)}),a}function h(t,e,n){try{return{type:"normal",arg:t.call(e,n)}}catch(t){return{type:"throw",arg:t}}}e.wrap=l;var f="suspendedStart",y="suspendedYield",p="executing",d="completed",m={};function v(){}function g(){}function w(){}var b={};u(b,a,(function(){return this}));var E=Object.getPrototypeOf,k=E&&E(E(C([])));k&&k!==n&&r.call(k,a)&&(b=k);var x=w.prototype=v.prototype=Object.create(b);function S(t){["next","throw","return"].forEach((function(e){u(t,e,(function(t){return this._invoke(e,t)}))}))}function R(t,e){function n(i,o,a,s){var c=h(t[i],t,o);if("throw"!==c.type){var u=c.arg,l=u.value;return l&&"object"==Rt(l)&&r.call(l,"__await")?e.resolve(l.__await).then((function(t){n("next",t,a,s)}),(function(t){n("throw",t,a,s)})):e.resolve(l).then((function(t){u.value=t,a(u)}),(function(t){return n("throw",t,a,s)}))}s(c.arg)}var o;i(this,"_invoke",{value:function(t,r){function i(){return new e((function(e,i){n(t,r,e,i)}))}return o=o?o.then(i,i):i()}})}function P(e,n,r){var i=f;return function(o,a){if(i===p)throw Error("Generator is already running");if(i===d){if("throw"===o)throw a;return{value:t,done:!0}}for(r.method=o,r.arg=a;;){var s=r.delegate;if(s){var c=M(s,r);if(c){if(c===m)continue;return c}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(i===f)throw i=d,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);i=p;var u=h(e,n,r);if("normal"===u.type){if(i=r.done?d:y,u.arg===m)continue;return{value:u.arg,done:r.done}}"throw"===u.type&&(i=d,r.method="throw",r.arg=u.arg)}}}function M(e,n){var r=n.method,i=e.iterator[r];if(i===t)return n.delegate=null,"throw"===r&&e.iterator.return&&(n.method="return",n.arg=t,M(e,n),"throw"===n.method)||"return"!==r&&(n.method="throw",n.arg=new TypeError("The iterator does not provide a '"+r+"' method")),m;var o=h(i,e.iterator,n.arg);if("throw"===o.type)return n.method="throw",n.arg=o.arg,n.delegate=null,m;var a=o.arg;return a?a.done?(n[e.resultName]=a.value,n.next=e.nextLoc,"return"!==n.method&&(n.method="next",n.arg=t),n.delegate=null,m):a:(n.method="throw",n.arg=new TypeError("iterator result is not an object"),n.delegate=null,m)}function L(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function j(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function O(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(L,this),this.reset(!0)}function C(e){if(e||""===e){var n=e[a];if(n)return n.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var i=-1,o=function n(){for(;++i<e.length;)if(r.call(e,i))return n.value=e[i],n.done=!1,n;return n.value=t,n.done=!0,n};return o.next=o}}throw new TypeError(Rt(e)+" is not iterable")}return g.prototype=w,i(x,"constructor",{value:w,configurable:!0}),i(w,"constructor",{value:g,configurable:!0}),g.displayName=u(w,c,"GeneratorFunction"),e.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===g||"GeneratorFunction"===(e.displayName||e.name))},e.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,w):(t.__proto__=w,u(t,c,"GeneratorFunction")),t.prototype=Object.create(x),t},e.awrap=function(t){return{__await:t}},S(R.prototype),u(R.prototype,s,(function(){return this})),e.AsyncIterator=R,e.async=function(t,n,r,i,o){void 0===o&&(o=Promise);var a=new R(l(t,n,r,i),o);return e.isGeneratorFunction(n)?a:a.next().then((function(t){return t.done?t.value:a.next()}))},S(x),u(x,c,"Generator"),u(x,a,(function(){return this})),u(x,"toString",(function(){return"[object Generator]"})),e.keys=function(t){var e=Object(t),n=[];for(var r in e)n.push(r);return n.reverse(),function t(){for(;n.length;){var r=n.pop();if(r in e)return t.value=r,t.done=!1,t}return t.done=!0,t}},e.values=C,O.prototype={constructor:O,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=t,this.done=!1,this.delegate=null,this.method="next",this.arg=t,this.tryEntries.forEach(j),!e)for(var n in this)"t"===n.charAt(0)&&r.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=t)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var n=this;function i(r,i){return s.type="throw",s.arg=e,n.next=r,i&&(n.method="next",n.arg=t),!!i}for(var o=this.tryEntries.length-1;o>=0;--o){var a=this.tryEntries[o],s=a.completion;if("root"===a.tryLoc)return i("end");if(a.tryLoc<=this.prev){var c=r.call(a,"catchLoc"),u=r.call(a,"finallyLoc");if(c&&u){if(this.prev<a.catchLoc)return i(a.catchLoc,!0);if(this.prev<a.finallyLoc)return i(a.finallyLoc)}else if(c){if(this.prev<a.catchLoc)return i(a.catchLoc,!0)}else{if(!u)throw Error("try statement without catch or finally");if(this.prev<a.finallyLoc)return i(a.finallyLoc)}}}},abrupt:function(t,e){for(var n=this.tryEntries.length-1;n>=0;--n){var i=this.tryEntries[n];if(i.tryLoc<=this.prev&&r.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var o=i;break}}o&&("break"===t||"continue"===t)&&o.tryLoc<=e&&e<=o.finallyLoc&&(o=null);var a=o?o.completion:{};return a.type=t,a.arg=e,o?(this.method="next",this.next=o.finallyLoc,m):this.complete(a)},complete:function(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),m},finish:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var n=this.tryEntries[e];if(n.finallyLoc===t)return this.complete(n.completion,n.afterLoc),j(n),m}},catch:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var n=this.tryEntries[e];if(n.tryLoc===t){var r=n.completion;if("throw"===r.type){var i=r.arg;j(n)}return i}}throw Error("illegal catch attempt")},delegateYield:function(e,n,r){return this.delegate={iterator:C(e),resultName:n,nextLoc:r},"next"===this.method&&(this.arg=t),m}},e}function Mt(t,e,n,r,i,o,a){try{var s=t[o](a),c=s.value}catch(t){return void n(t)}s.done?e(c):Promise.resolve(c).then(r,i)}function Lt(t){return function(){var e=this,n=arguments;return new Promise((function(r,i){var o=t.apply(e,n);function a(t){Mt(o,r,i,a,s,"next",t)}function s(t){Mt(o,r,i,a,s,"throw",t)}a(void 0)}))}}function jt(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,Ot(r.key),r)}}function Ot(t){var e=function(t){if("object"!=Rt(t)||!t)return t;var e=t[Symbol.toPrimitive];if(void 0!==e){var n=e.call(t,"string");if("object"!=Rt(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==Rt(e)?e:e+""}function Ct(t){"undefined"!=typeof window&&window.debugLog?window.debugLog("Game",t):console.log("[Game] ".concat(t))}var Tt=function(){return t=function t(){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),Ct("Инициализация игры..."),this.update=this.update.bind(this),this.fixedUpdate=this.fixedUpdate.bind(this),this.events=new B(this),this.state=new _(this),this.ui=new y(this),this.world=new A(this),this.gameTime=0,this.physicsUpdateRate=1/60,this.physicsAccumulator=0,this.lastFrameTime=0,this.init()},e=[{key:"init",value:(o=Lt(Pt().mark((function t(){return Pt().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,this.ui.updateLoadingStatus("Инициализация компонентов..."),t.next=4,this.initBaseComponents();case 4:return Ct("Основные компоненты инициализированы"),t.next=7,this.loadResources();case 7:Ct("Ресурсы загружены"),this.ui.showMainMenu(),t.next=15;break;case 11:t.prev=11,t.t0=t.catch(0),Ct("Ошибка инициализации: ".concat(t.t0.message)),this.ui.showErrorScreen("Произошла ошибка при инициализации: ".concat(t.t0.message));case 15:case"end":return t.stop()}}),t,this,[[0,11]])}))),function(){return o.apply(this,arguments)})},{key:"initBaseComponents",value:(i=Lt(Pt().mark((function t(){return Pt().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,this.ui.updateLoadingStatus("Инициализация рендерера..."),this.renderer=new W(this.ui.gameCanvas),this.ui.updateLoadingStatus("Инициализация обработчика ввода..."),this.input=new J,this.ui.updateLoadingStatus("Инициализация сетевого менеджера..."),this.network=new ot,this.ui.updateLoadingStatus("Инициализация физического движка..."),this.physics=new St,this.ui.updateLoadingStatus("Инициализация UI компонентов..."),t.next=12,this.ui.initComponents();case 12:return this.events.setupEventListeners(),t.abrupt("return",!0);case 16:throw t.prev=16,t.t0=t.catch(0),Ct("Ошибка инициализации компонентов: ".concat(t.t0.message)),t.t0;case 20:case"end":return t.stop()}}),t,this,[[0,16]])}))),function(){return i.apply(this,arguments)})},{key:"loadResources",value:(r=Lt(Pt().mark((function t(){var e=this;return Pt().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return this.ui.updateLoadingStatus("Инициализация физического движка..."),t.prev=1,t.next=4,this.physics.init();case 4:if(t.sent){t.next=7;break}throw new Error("Не удалось инициализировать физику");case 7:return this.ui.updateLoadingStatus("Физический движок инициализирован"),this.ui.updateLoadingStatus("Загрузка игровых ресурсов..."),t.next=11,new Promise((function(t){setTimeout((function(){e.state.isLoading=!1,t()}),1e3)}));case 11:return this.ui.updateLoadingStatus("Все ресурсы загружены успешно"),t.abrupt("return",!0);case 15:throw t.prev=15,t.t0=t.catch(1),Ct("Ошибка загрузки ресурсов: ".concat(t.t0.message)),t.t0;case 19:case"end":return t.stop()}}),t,this,[[1,15]])}))),function(){return r.apply(this,arguments)})},{key:"startGame",value:(n=Lt(Pt().mark((function t(){return Pt().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,Ct("Запуск игры..."),this.ui.hideMainMenu(),this.ui.showGameScreen(),this.state.isRunning=!0,this.state.currentScene="game",this.renderer&&(this.renderer.setupScene(),Ct("Сцена настроена")),t.next=9,this.world.initialize();case 9:this.network.connect().then((function(){Ct("Подключено к серверу (прототип)")})).catch((function(t){Ct("Ошибка подключения: ".concat(t.message))})),this.lastFrameTime=performance.now(),requestAnimationFrame(this.update),Ct("Игра запущена"),t.next=19;break;case 15:t.prev=15,t.t0=t.catch(0),Ct("Ошибка при запуске игры: ".concat(t.t0.message)),this.ui.showErrorScreen("Ошибка при запуске игры: ".concat(t.t0.message));case 19:case"end":return t.stop()}}),t,this,[[0,15]])}))),function(){return n.apply(this,arguments)})},{key:"fixedUpdate",value:function(t){try{this.network&&this.network.isConnected,this.world.fixedUpdate(t)}catch(t){Ct("Ошибка в fixedUpdate: ".concat(t.message))}}},{key:"update",value:function(t){if(this.state.isRunning)try{var e=performance.now(),n=(e-this.lastFrameTime)/1e3;this.lastFrameTime=e;var r=Math.min(n,.1);for(this.gameTime+=r,this.physicsAccumulator+=r;this.physicsAccumulator>=this.physicsUpdateRate;)this.physics&&this.physics.isReady()&&this.physics.update(this.physicsUpdateRate),this.fixedUpdate(this.physicsUpdateRate),this.physicsAccumulator-=this.physicsUpdateRate;this.world.update(r),this.renderer&&this.renderer.render(this.world.player),this.ui.update(),requestAnimationFrame(this.update)}catch(t){Ct("Ошибка в игровом цикле: ".concat(t.message)),requestAnimationFrame(this.update)}}}],e&&jt(t.prototype,e),Object.defineProperty(t,"prototype",{writable:!1}),t;var t,e,n,r,i,o}();document.addEventListener("DOMContentLoaded",(function(){try{Ct("DOMContentLoaded: инициализация игры"),window.game=new Tt}catch(e){console.error("Критическая ошибка при инициализации игры:",e);var t=document.createElement("div");t.style.cssText="\n            position: fixed;\n            top: 0;\n            left: 0;\n            width: 100%;\n            padding: 20px;\n            background-color: #f44336;\n            color: white;\n            text-align: center;\n            font-size: 18px;\n            z-index: 9999;\n        ",t.textContent="Критическая ошибка: ".concat(e.message),document.body.appendChild(t)}}))})();
//# sourceMappingURL=bundle.js.map